<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNICON App</title>
  <link rel="icon" href="UNICON.png?v=1758434378" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
  <script defer crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body, #root { height: 100%; }
    :root{ --brand-color:#1D4E89; --bg:#fbf7f3; --card:#ffffff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); font-size:14px; line-height:1.5; }
    .wm{position:absolute;inset:0;pointer-events:none;background-repeat:no-repeat;background-position:center;background-size:clamp(320px,40vw,720px);opacity:.07;background-attachment:fixed}
    /* Brand helpers */
    .btn-brand{ background:var(--brand-color); color:#fff; }
    .btn-brand:hover{ filter:brightness(.95); }
    .btn-brand:focus{ outline:2px solid color-mix(in srgb, var(--brand-color) 50%, white); outline-offset:2px; }
    .chip-brand{ border:1px solid var(--brand-color); color:var(--brand-color); background:color-mix(in srgb, var(--brand-color) 10%, #fff); }
    /* Unified focus ring */
    :focus-visible { outline:2px solid color-mix(in srgb, var(--brand-color) 60%, white); outline-offset:2px; }
    /* Card + modal shadows */
    .shadow-card{ box-shadow: 0 8px 20px rgba(0,0,0,.06); }
    .shadow-modal{ box-shadow: 0 12px 40px rgba(0,0,0,.25); }
    /* Skeleton shimmer */
    .skeleton{ position:relative; overflow:hidden; background:linear-gradient(90deg, rgba(148,163,184,.15), rgba(148,163,184,.25), rgba(148,163,184,.15)); background-size:200% 100%; animation:sheen 1.2s linear infinite; }
    @keyframes sheen{ 0%{ background-position:200% 0 } 100%{ background-position:-200% 0 }}
    /* Optional dark theme overrides */
    body.theme-dark{ --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937; }
    body.theme-dark .bg-white{ background:var(--card) !important; }
    body.theme-dark .border-slate-200{ border-color:var(--border) !important; }
    body.theme-dark .text-slate-900{ color:var(--text) !important; }
    body.theme-dark .text-slate-700{ color:var(--muted) !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="env,react">
    const fm = window.framerMotion || {};
    const reduceMotion = (typeof window!=='undefined' && window.matchMedia) ? window.matchMedia('(prefers-reduced-motion: reduce)').matches : false;
    const MotionDiv = (fm.motion && !reduceMotion) ? (p)=>React.createElement(fm.motion.div,p) : (p)=> <div {...p}/>;
    const { useState } = React;
    function getBranding(){ try { return JSON.parse(localStorage.getItem('uniconBrand')||'null'); }catch{ return null; } }
    function applyBranding(b){ const root = document.body; if (b?.color){ root.style.setProperty('--brand-color', b.color);} }
    function getPrefs(){ try{ return JSON.parse(localStorage.getItem('unicon_prefs')||'null')||{}; }catch{ return {}; } }
    function setPrefs(p){ try{ localStorage.setItem('unicon_prefs', JSON.stringify(p)); }catch{} }
    // small storage helpers
    const store = {
      get(key, fallback){ try{ const v = JSON.parse(localStorage.getItem(key)||'null'); return (v==null? fallback : v); }catch{ return fallback; } },
      set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} },
    };
    const branding = getBranding(); applyBranding(branding);
    // Toast utility
    function toast(message, type='info'){ try{ window.dispatchEvent(new CustomEvent('unicon_toast', { detail:{ message, type, id:String(Date.now()) } })); }catch{} }
    function useToasts(){ const [toasts, setToasts] = React.useState([]); React.useEffect(()=>{ function on(e){ const t=e.detail; setToasts(list=> [...list, t]); setTimeout(()=> setToasts(list=> list.filter(x=> x.id!==t.id)), 3500); } window.addEventListener('unicon_toast', on); return ()=> window.removeEventListener('unicon_toast', on); },[]); return [toasts, setToasts]; }
    function Toasts(){ const [toasts]=useToasts(); return (<div className="fixed top-3 right-3 z-[60] space-y-2">{toasts.map(t=> (<div key={t.id} className={`rounded-xl px-3 py-2 text-sm border shadow-card ${t.type==='error'?'bg-red-50 border-red-200 text-red-800': t.type==='success'?'bg-green-50 border-green-200 text-green-800':'bg-white border-slate-200 text-slate-800'}`}>{t.message}</div>))}</div>); }
    // Confirm dialog
    function confirmDialog(msg){ return new Promise(res=>{ try{ window.dispatchEvent(new CustomEvent('unicon_confirm', { detail:{ message:msg, resolve:res } })); }catch{ const c=window.confirm(msg); res(c); } }); }
    function ConfirmDialog(){ const [state, setState]=React.useState(null); React.useEffect(()=>{ function on(e){ setState(e.detail); } window.addEventListener('unicon_confirm', on); return ()=> window.removeEventListener('unicon_confirm', on); },[]); if(!state) return null; return (
      <div className="fixed inset-0 z-[70] bg-black/40 grid place-items-center p-3" role="dialog" aria-modal="true" onKeyDown={(e)=>{ if(e.key==='Escape'){ state.resolve(false); setState(null);} }}>
        <div className="bg-white rounded-2xl border border-slate-200 p-4 max-w-sm w-full shadow-modal">
          <div className="text-slate-800 text-sm mb-3">{state.message}</div>
          <div className="flex items-center justify-end gap-2">
            <button className="rounded-full px-3 py-2 text-sm border" onClick={()=>{ state.resolve(false); setState(null); }}>Cancel</button>
            <button className="rounded-full px-3 py-2 text-sm btn-brand" onClick={()=>{ state.resolve(true); setState(null); }}>Confirm</button>
          </div>
        </div>
      </div>
    ); }

    // Image compression helper (max 1600px)
    async function compressImage(dataUrl, max=1600){
      try{
        const img = new Image(); img.src = dataUrl; await new Promise(r=>{ img.onload=r; img.onerror=r; });
        const w = img.width, h = img.height; const scale = Math.min(1, max/Math.max(w,h));
        if(scale>=1) return dataUrl;
        const canvas = document.createElement('canvas'); canvas.width = Math.round(w*scale); canvas.height = Math.round(h*scale);
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL('image/jpeg', 0.85);
      }catch{ return dataUrl; }
    }

    // Command Palette
    function CommandPalette({ open, onClose, onNavigate }){
      const [q, setQ] = React.useState('');
      const tabs = [
        { id:'forYou', label:'Dashboard' },
        { id:'community', label:'Community' },
        { id:'marketplace', label:'Marketplace' },
        { id:'calendar', label:'Calendar' },
        { id:'profile', label:'Profile' },
      ];
      const base = [
        ...tabs.map(t=> ({ type:'tab', id:t.id, label:t.label })),
        { type:'space', id:'community:start', label:'Community – Start Here' },
        { type:'space', id:'community:announcements', label:'Community – Announcements' },
        { type:'space', id:'community:events', label:'Community – Events' },
        { type:'space', id:'community:study', label:'Community – Live Study' },
        { type:'space', id:'community:club:General Club', label:'Community – General Club' },
      ];
      // Departments and clubs for palette
      try{
        const deps = JSON.parse(localStorage.getItem('unicon_departments')||'null')||[];
        deps.forEach(d=> base.push({ type:'space', id:`community:dep:${d}`, label:`Department – ${d}` }));
        const clubs = JSON.parse(localStorage.getItem('unicon_clubs')||'null')||[];
        clubs.forEach(c=> base.push({ type:'space', id:`community:club:${c}`, label:`Club – ${c}` }));
      }catch{}
      const list = base.filter(x=> x.label.toLowerCase().includes(q.toLowerCase()));
      function choose(item){
        if(item.type==='tab') onNavigate({ tab:item.id });
        if(item.type==='space'){
          onNavigate({ tab:'community', space:item.id.replace('community:','') });
        }
      }
      function onEnter(){
        if(q.toLowerCase().startsWith('market:')){
          const s = q.slice(7).trim(); try{ localStorage.setItem('unicon_market_cmd_query', s); }catch{}
          onNavigate({ tab:'marketplace' }); return;
        }
        if(list[0]) choose(list[0]);
      }
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-[80] bg-black/40 p-3" role="dialog" aria-modal="true" onClick={onClose} onKeyDown={(e)=>{ if(e.key==='Escape') onClose(); }}>
          <div className="max-w-xl mx-auto" onClick={(e)=>e.stopPropagation()}>
            <div className="bg-white rounded-2xl border border-slate-200 shadow-modal">
              <div className="p-2 border-b border-slate-200">
                <input autoFocus value={q} onChange={e=>setQ(e.target.value)} onKeyDown={(e)=>{ if(e.key==='Enter') onEnter(); }} placeholder="Type to search • 'market: laptop' to search marketplace" className="w-full px-3 py-2 rounded-lg border border-slate-200"/>
              </div>
              <ul className="max-h-72 overflow-auto p-1">
                {list.slice(0,8).map(it=> (
                  <li key={it.id}><button onClick={()=>choose(it)} className="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50">{it.label}</button></li>
                ))}
                {list.length===0 && <li className="px-3 py-2 text-sm text-slate-600">No results</li>}
              </ul>
            </div>
          </div>
        </div>
      );
    }
    // Optional: previously used for gating, now unused but harmless
    const currentPlan = (branding && branding.plan) ? branding.plan : 'Pro';
    // Student app is plan-agnostic. Plans belong to landing/registration only.
    const API_BASE = 'api';
    async function api(path, options={}){ const res = await fetch(`${API_BASE}/${String(path).replace(/^\//,'')}`, { method:'GET', headers:{'Content-Type':'application/json'}, ...options}); let data={}; try{ data = await res.json(); }catch{} if(!res.ok) throw new Error(data?.error||`Request failed (${res.status})`); return data; }

    // import the full App code from index.html by inlining the minimal subset we need
    // For brevity and to avoid duplication, we display a simple mount that reuses the same structure
    // via iframe-like navigation would be overkill; instead we copy the App function core from index

    function LogoMark({ size = 56 }){
      const b = getBranding();
      return <img src={b?.logoData || 'UNICON.png?v=1758434378'} alt="UNICON" style={{ width:size,height:size }} className="rounded-xl object-contain"/>;
    }

    // Simple poll voting widget
    function ClubPoll({ poll, pid, storageKey }){
      const voteKey = `${storageKey}:poll:${pid}`;
      const [vote, setVote] = React.useState(()=>{ try{ return localStorage.getItem(voteKey)||''; }catch{ return ''; } });
      function choose(v){ setVote(v); try{ localStorage.setItem(voteKey, v); }catch{} }
      return (
        <div className="mt-2">
          <div className="font-medium">{poll.q||'Poll'}</div>
          <div className="mt-1 grid sm:grid-cols-2 gap-2">
            {['a','b'].map(k=> (
              <button key={k} onClick={()=>choose(k)} className={`rounded-lg px-3 py-2 text-sm border ${vote===k? 'chip-brand':'border-slate-200 bg-slate-50'}`}>{poll[k]||`Option ${k.toUpperCase()}`}</button>
            ))}
          </div>
        </div>
      );
    }

    const Home = (props)=> (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
    );
    const Users = (props)=>(
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    );
    const MessageSquare = (props)=>(
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    );
    const CalendarDays = (props)=>(
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    );
    const Store = (props)=>(
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M3 9l1-5h16l1 5"/><path d="M21 9H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z"/><path d="M16 13a4 4 0 0 1-8 0"/></svg>
    );
    const LogOut = (props)=>(
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    );
    const Bell = (props)=>(
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M6 8a6 6 0 1 1 12 0c0 7 3 8 3 8H3s3-1 3-8"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    );
    const Bookmark = (props)=>(
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M19 21l-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
    );
    const SearchIcon = (props)=>(
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    );

    function BottomNav({ active, onChange }){
      const items = [
        { key:'forYou', label:'For you', icon: Home },
        { key:'community', label:'Community', icon: Users },
        { key:'moments', label:'Messages', icon: MessageSquare },
        { key:'marketplace', label:'Marketplace', icon: Store },
        { key:'calendar', label:'Calendar', icon: CalendarDays },
        { key:'profile', label:'Profile', icon: Users },
      ];
      return (
        <nav className="fixed bottom-2 left-1/2 -translate-x-1/2 z-40">
          <ul className="flex gap-1 bg-white/90 backdrop-blur border border-slate-200 rounded-2xl p-1 shadow-xl">
            {items.map(({key,label,icon:Icon})=> (
              <li key={key}><button aria-label={label} onClick={()=>onChange(key)} className={`flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm transition-all ${active===key? 'bg-[var(--brand-color)] text-white shadow' : 'text-slate-700 hover:bg-slate-100'}`}><Icon/><span className="hidden sm:inline">{label}</span></button></li>
            ))}
          </ul>
        </nav>
      );
    }

    function ForYouFeed(){
      const [items, setItems] = React.useState(()=>{
        try{ return JSON.parse(localStorage.getItem('unicon_feed')||'null') || [
          { id: 'a1', title: 'Welcome back!', body: 'Orientation this Monday at 9:00 AM.', pinned: false, audience: 'All', likes:0, comments:[] },
          { id: 'a2', title: 'Book fair', body: 'Opens Wednesday in the main hall.', pinned: false, audience: 'All', likes:0, comments:[] },
        ]; }catch{ return []; }
      });
      const [title, setTitle] = React.useState('');
      const [body, setBody] = React.useState('');
      const [audience, setAudience] = React.useState('All');
      const canPost = true;
      const canPin = false;
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_feed', JSON.stringify(items)); }catch{} }, [items]);
      function add(){ if(!title.trim()||!body.trim()) return; setItems([{ id: String(Date.now()), title, body, pinned:false, audience, likes:0, comments:[] }, ...items]); setTitle(''); setBody(''); }
      function like(id){ setItems(arr=> arr.map(i=> i.id===id? {...i, likes:(i.likes||0)+1 }: i)); }
      function addComment(id, text){ if(!text.trim()) return; setItems(arr=> arr.map(i=> i.id===id? {...i, comments:[...i.comments, { id:String(Date.now()), text }] }: i)); }
      function pin(id){ /* no-op: pinning reserved for admins */ }
      const sorted = [...items].sort((a,b)=> Number(b.pinned)-Number(a.pinned));
      return (
        <div className="space-y-4">
          {/* Students can post. Admin-only features (pin/target) hidden. */}
          {canPost && (
            <div className="rounded-xl border border-slate-200 bg-white p-4 space-y-2">
              <div className="grid gap-2 md:grid-cols-2">
                <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Announcement title" className="rounded-lg border border-slate-300 px-3 py-2" />
                {/* Audience targeting hidden for students */}
              </div>
              <textarea value={body} onChange={e=>setBody(e.target.value)} placeholder="Write your update…" className="w-full rounded-lg border border-slate-300 px-3 py-2"></textarea>
              <button onClick={add} className="rounded-lg px-4 py-2 text-sm btn-brand">Post</button>
            </div>
          )}
          {sorted.map(it=> (
            <div key={it.id} className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
              <div className="flex items-center justify-between mb-1">
                <h3 className="font-semibold">{it.title}{it.pinned && <span className="ml-2 text-xs px-2 py-0.5 rounded-full" style={{ background:'color-mix(in srgb, var(--brand-color) 10%, white)', color:'var(--brand-color)' }}>Pinned</span>}</h3>
                <div className="flex items-center gap-2 text-xs text-slate-600"></div>
              </div>
              <p className="text-slate-600">{it.body}</p>
              <div className="mt-3 flex items-center gap-3 text-sm">
                <button onClick={()=>like(it.id)} className="px-3 py-1 rounded-lg border border-slate-200 hover:bg-slate-50">👍 {it.likes||0}</button>
                <details className="flex-1">
                  <summary className="cursor-pointer text-slate-600">Comments ({it.comments?.length||0})</summary>
                  <div className="mt-2 space-y-2">
                    {(it.comments||[]).map(c=> (<div key={c.id} className="text-sm text-slate-700">• {c.text}</div>))}
                    <CommentBox onSubmit={(t)=>addComment(it.id, t)} />
                  </div>
                </details>
              </div>
            </div>
          ))}
        </div>
      );
    }
    function CommentBox({ onSubmit }){
      const [t, setT] = React.useState('');
      return (
        <div className="flex gap-2">
          <input value={t} onChange={e=>setT(e.target.value)} placeholder="Write a comment" className="flex-1 rounded-lg border border-slate-300 px-3 py-1"/>
          <button onClick={()=>{ onSubmit(t); setT(''); }} className="px-3 py-1 rounded-lg btn-brand">Send</button>
        </div>
      );
    }
    function Placeholder({note='Coming soon'}){ return <div className="grid place-items-center py-16 text-slate-600">{note}</div>; }

    // --- Messages (simple messenger) ---
    function Moments(){
      const [threads, setThreads] = React.useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_msgs_threads')||'null')||[{ id:'general', name:'Student Hub' }]; }catch{ return [{id:'general',name:'Student Hub'}]; } });
      const [active, setActive] = React.useState('general');
      const [msgs, setMsgs] = React.useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_msgs')||'null')||{ general:[] }; }catch{ return { general:[] }; } });
      const [text, setText] = React.useState('');
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_msgs', JSON.stringify(msgs)); }catch{} }, [msgs]);
      function send(){ if(!text.trim()) return; const email=localStorage.getItem('uniconSessionEmail')||'You'; const m={ id:String(Date.now()), from:email, text, t:Date.now() }; setMsgs(s=> ({ ...s, [active]: [...(s[active]||[]), m] })); setText(''); }
      function addThread(){ const name=prompt('New conversation name'); if(!name) return; const id=String(Date.now()); setThreads(t=>[...t,{id,name}]); setMsgs(s=> ({...s,[id]:[]})); setActive(id); }
      const list = msgs[active]||[];
      return (
        <div className="grid md:grid-cols-[240px_1fr] gap-3">
          <aside className="rounded-xl border border-slate-200 bg-white p-2">
            <div className="flex items-center justify-between mb-2"><div className="text-sm font-semibold">Messages</div><button onClick={addThread} className="text-xs px-2 py-1 rounded border">New</button></div>
            <div className="space-y-1">
              {threads.map(t=> (
                <button key={t.id} onClick={()=>setActive(t.id)} className={`w-full text-left px-3 py-2 rounded-lg text-sm ${active===t.id?'chip-brand':'hover:bg-slate-50 border border-transparent'}`}>{t.name}</button>
              ))}
            </div>
          </aside>
          <section className="rounded-xl border border-slate-200 bg-white p-3 flex flex-col min-h-[300px]">
            <div className="font-medium mb-2">{(threads.find(t=>t.id===active)||{}).name||'Chat'}</div>
            <div className="flex-1 overflow-auto space-y-2 pr-1">
              {list.map(m=> (
                <div key={m.id} className={`max-w-[80%] rounded-lg px-3 py-2 ${m.from===localStorage.getItem('uniconSessionEmail')? 'ml-auto bg-[var(--brand-color)] text-white' : 'bg-slate-100'}`}>{m.text}</div>
              ))}
              {list.length===0 && <div className="text-sm text-slate-500">No messages yet.</div>}
            </div>
            <div className="mt-2 flex gap-2"><input value={text} onChange={e=>setText(e.target.value)} onKeyDown={e=>{ if(e.key==='Enter') send(); }} placeholder="Write a message" className="flex-1 rounded-full border border-slate-300 px-3 py-2"/><button onClick={send} className="rounded-full px-4 py-2 btn-brand">Send</button></div>
          </section>
        </div>
      );
    }

    // --- Sidebar ---
    function Sidebar({ active, onSelect }){
      const Item = ({ k, label, Icon, badge }) => (
        <button onClick={()=>onSelect(k)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm ${active===k? 'bg-white shadow border border-slate-200 text-slate-900':'text-slate-700 hover:bg-white/60'}`}>
          <Icon className="w-5 h-5"/>
          <span className="flex-1 text-left">{label}</span>
          {badge && <span className="text-[10px] uppercase tracking-wide bg-slate-900 text-white px-2 py-0.5 rounded">{badge}</span>}
        </button>
      );
      // No longer used (left sidebar removed); keeping for reference
      return null;
    }

    // --- Top Tabs Navigation (desktop) ---
    function TabsNav({ active, onSelect }){
      const items = [
        { k:'forYou', label:'Dashboard', Icon: Home },
        { k:'forums', label:'Forums', Icon: Users },
        { k:'marketplace', label:'Marketplace', Icon: Store },
        { k:'calendar', label:'Events', Icon: CalendarDays },
        { k:'profile', label:'Profile', Icon: Users },
      ];
      return (
        <nav className="hidden md:block">
          <ul className="flex flex-wrap gap-2">
            {items.map(({k,label,Icon})=> (
              <li key={k}>
                <button onClick={()=>onSelect(k)} className={`inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm border ${active===k? 'chip-brand' : 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50'}`}>
                  <Icon className="w-4 h-4"/>
                  <span>{label}</span>
                </button>
              </li>
            ))}
          </ul>
        </nav>
      );
    }

    function Forums(){
      // Departments (left list)
      const defaultDeps = ['Computer Science','Data Science','Engineering','Business','Nursing'];
      const [departments, setDepartments] = useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_departments')||'null') || defaultDeps; }catch{ return defaultDeps; } });
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_departments', JSON.stringify(departments)); }catch{} }, [departments]);

      // Career Clubs (new)
      const defaultClubs = ['CodePsi','Código','Computer Science','Data Science','English Language Learners','Flutter','Future Founders & Freelancers','Machine & Deep Learning','Mobile Development','Python'];
      const [clubs, setClubs] = useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_clubs')||'null') || defaultClubs; }catch{ return defaultClubs; } });
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_clubs', JSON.stringify(clubs)); }catch{} }, [clubs]);

      // Selected space: 'start' | 'announcements' | 'events' | 'study' | `dep:<name>` | `club:<name>`
      const [space, _setSpace] = useState('start');
      const [history, setHistory] = useState([]);
      function goTo(next){ setHistory(h=> [...h, space]); _setSpace(next); try{ location.hash = `#space=${encodeURIComponent(next)}`; }catch{} }
      function goBack(){ setHistory(h=>{ const copy=[...h]; const prev=copy.pop(); if(prev){ _setSpace(prev); try{ location.hash = `#space=${encodeURIComponent(prev)}`; }catch{} } return copy; }); }
      // hash routing
      React.useEffect(()=>{
        const applyFromHash = ()=>{
          const m = String(location.hash||'').match(/space=([^&]+)/);
          if(m){ const val = decodeURIComponent(m[1]); _setSpace(val); }
        };
        applyFromHash();
        const onHash = ()=> applyFromHash();
        window.addEventListener('hashchange', onHash);
        return ()=> window.removeEventListener('hashchange', onHash);
      }, []);
      const [newDep, setNewDep] = useState('');

      function spaceTitle(s){
        if(s==='start') return 'Start Here';
        if(s==='announcements') return 'Announcements';
        if(s==='events') return 'Events';
        if(s==='study') return 'Live Study';
        if(String(s||'').startsWith('dep:')) return s.slice(4);
        if(String(s||'').startsWith('club:')) return s.slice(5);
        return 'Space';
      }
      // Dept → Clubs mapping (no department-level General; we provide one global General Club)
      const deptClubs = {
        'Computer Science': ['Computer Science','Programming 101','AI Society','Open Source'],
        'Data Science': ['Data Science','Machine Learning','Analytics'],
        'Engineering': ['Engineering','Robotics','IoT'],
        'Business': ['Business','Entrepreneurship','Marketing'],
        'Nursing': ['Nursing','Pre‑Med','Healthcare Tech'],
      };
      const listClubs = (dep)=> (deptClubs[dep] || [`${dep} Club`]);
      const spaceKey = `unicon_space:${space}`;
      const [posts, setPosts] = useState(()=>{ try{ return JSON.parse(localStorage.getItem(spaceKey)||'null') || []; }catch{ return []; } });
      React.useEffect(()=>{ try{ localStorage.setItem(spaceKey, JSON.stringify(posts)); }catch{} }, [posts, spaceKey]);
      // Reload posts when switching spaces
      React.useEffect(()=>{ try{ setPosts(JSON.parse(localStorage.getItem(`unicon_space:${space}`)||'null')||[]); }catch{ setPosts([]);} }, [space]);

      function addPost(text, media){ if(!text.trim() && !media) return; setPosts([{ id:String(Date.now()), text, media, created: Date.now() }, ...posts]); }
      function removePost(id){ setPosts(arr=> arr.filter(p=> p.id!==id)); }
      function countPostsFor(dep){ try{ const k=`unicon_space:dep:${dep}`; const arr=JSON.parse(localStorage.getItem(k)||'null')||[]; return arr.length; }catch{ return 0; } }
      function countPostsForClub(name){ try{ const k=`unicon_club:${name}`; const arr=JSON.parse(localStorage.getItem(k)||'null')||[]; return arr.length; }catch{ return 0; } }
      function addDepartment(){ if(!newDep.trim()) return; if(departments.includes(newDep.trim())) return; setDepartments([...departments, newDep.trim()]); setNewDep(''); }

      return (
        <div className="grid lg:grid-cols-[260px_1fr] gap-3">
          <aside className="space-y-4">
            <div className="rounded-2xl border border-slate-200 bg-white p-3">
              <div className="text-xs font-semibold text-slate-500 px-1 mb-1">Community</div>
              <nav className="space-y-1" role="navigation" aria-label="Community">
                <button onClick={()=>goTo('start')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='start'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>✨ Start Here</button>
                <button onClick={()=>goTo('announcements')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='announcements'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>📣 Announcements</button>
                <button onClick={()=>goTo('events')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='events'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>📅 Events</button>
                <button onClick={()=>goTo('study')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='study'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>📚 Live Study</button>
                <button onClick={()=>goTo('club:General Club')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='club:General Club'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>🌐 General Club</button>
              </nav>
            </div>
            <div className="rounded-2xl border border-slate-200 bg-white p-3">
              <div className="text-xs font-semibold text-slate-500 px-1 mb-2">Departments</div>
              <div className="space-y-1" role="navigation" aria-label="Departments">
                {departments.map(dep=> (
                  <button aria-current={space===`dep:${dep}`? 'page' : undefined} key={dep} onClick={()=>goTo(`dep:${dep}`)} className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm ${space===`dep:${dep}`?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>
                    <span>🏷️ {dep}</span>
                    <span className="text-[10px] text-slate-500">{countPostsFor(dep)}</span>
                  </button>
                ))}
              </div>
              <div className="mt-2 flex gap-2">
                <input value={newDep} onChange={e=>setNewDep(e.target.value)} placeholder="Add department" className="flex-1 rounded-lg border border-slate-300 px-2 py-1 text-sm"/>
                <button onClick={addDepartment} className="rounded-lg px-2 py-1 text-xs btn-brand">Add</button>
              </div>
            </div>

            <div className="rounded-2xl border border-slate-200 bg-white p-3">
              <div className="text-xs font-semibold text-slate-500 px-1 mb-2">Career Clubs</div>
              <div className="space-y-1 max-h-[320px] overflow-auto pr-1" role="navigation" aria-label="Career Clubs">
                {clubs.map(name=> (
                  <button aria-current={space===`club:${name}`? 'page' : undefined} key={name} onClick={()=>goTo(`club:${name}`)} className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm ${space===`club:${name}`?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>
                    <span>🧩 {name}</span>
                    <span className="text-[10px] text-slate-500">{countPostsForClub(name)}</span>
                  </button>
                ))}
              </div>
            </div>
          </aside>

          <section>
            <div className="rounded-2xl border border-slate-200 bg-white p-4 mb-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <button onClick={goBack} disabled={history.length===0} className={`h-8 w-8 grid place-items-center rounded-md border ${history.length===0? 'opacity-40 cursor-not-allowed' : 'hover:bg-slate-50'}`}>←</button>
                <div className="text-lg font-semibold">{spaceTitle(space)}</div>
              </div>
              <JoinSpaceButton key={space} space={space} />
            </div>

            {String(space).startsWith('club:') ? (
              <ClubView name={space.slice(5)} />
            ) : String(space).startsWith('dep:') ? (
              <DepartmentView
                name={space.slice(4)}
                clubs={listClubs(space.slice(4))}
                posts={posts}
                onPost={addPost}
                onRemove={removePost}
                onOpenClub={(club)=> goTo(`club:${club}`)}
              />
            ) : space==='study' ? (
              <LiveStudy />
            ) : space==='start' ? (
              <CommunityStart onGo={(dest)=>{
                if(dest.startsWith('dep:')){ const name = dest.slice(4); if(!departments.includes(name)) setDepartments([...departments, name]); goTo(dest); return; }
                if(dest.startsWith('club:')){ const name = dest.slice(5); if(!clubs.includes(name)) setClubs([...clubs, name]); goTo(dest); return; }
                if(dest==='study'){ goTo('study'); return; }
                if(['events','announcements','start'].includes(dest)){ goTo(dest); return; }
              }}/>
            ) : (
              <>
                <SpaceComposer onPost={addPost} />
                <div className="mt-3 space-y-3">
                  {posts.map(p=> (
                    <div key={p.id} className="rounded-xl border border-slate-200 bg-white p-4">
                      {p.text && <div className="text-slate-800">{p.text}</div>}
                      {p.media && <div className="mt-2"><img src={p.media} alt="media" className="max-h-72 rounded-lg object-cover"/></div>}
                      <div className="mt-2 text-xs text-slate-500 flex items-center justify-between"><span>{new Date(p.created).toLocaleString()}</span><button onClick={()=>removePost(p.id)} className="hover:underline">Delete</button></div>
                    </div>
                  ))}
                  {posts.length===0 && <div className="text-sm text-slate-500">No posts yet in this space.</div>}
                </div>
              </>
            )}
          </section>
        </div>
      );
    }

    // Join toggle for spaces (dep:, club:, study, etc.)
    function JoinSpaceButton({ space }){
      const [joined, setJoined] = React.useState(()=>{ try{ const m=JSON.parse(localStorage.getItem('unicon_memberships')||'{}'); return !!m[space]; }catch{ return false; } });
      function toggle(){ setJoined(j=>{ const next=!j; try{ const m=JSON.parse(localStorage.getItem('unicon_memberships')||'{}'); m[space]=next; localStorage.setItem('unicon_memberships', JSON.stringify(m)); }catch{} return next; }); }
      return (
        <button onClick={toggle} className={`rounded-full px-3 py-1 text-sm ${joined? 'text-green-700 bg-green-50 border border-green-200':'btn-brand'}`}>{joined? 'Joined' : 'Join space'}</button>
      );
    }

    // Community landing grid (Start Here)
    function CommunityStart({ onGo }){
      const cards = [
        { key:'lounge', title:'Hang Out in the Lounge', tag:'Social', dest:'start', emoji:'💬' },
        { key:'wins', title:'Post Your Weekly Wins', tag:'Celebrations', dest:'announcements', emoji:'🏆' },
        { key:'event', title:'Attend an Event', tag:'Calendar', dest:'events', emoji:'📅' },
        { key:'collab', title:'Collaborate in the Corner', tag:'Projects', dest:'dep:Projects', emoji:'🧩' },
        { key:'challenge', title:"Take on this Month's Challenge", tag:'Challenge', dest:'dep:Challenges', emoji:'🚩' },
        { key:'club', title:'Visit General Club', tag:'Clubs', dest:'club:General Club', emoji:'👥' },
        { key:'study', title:'Join a Live Study Room', tag:'Study', dest:'study', emoji:'📚' },
        { key:'team', title:'Meet the Community Team', tag:'Welcome', dest:'announcements', emoji:'🤝' },
        { key:'guide', title:'Read Our Community Guidelines', tag:'Guides', dest:'announcements', emoji:'📘' },
      ];
      return (
        <div className="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
          {cards.map(c=> (
            <button key={c.key} onClick={()=>onGo(c.dest)} className="text-left rounded-2xl overflow-hidden border border-slate-200 bg-white shadow-sm hover:shadow-md transition-shadow">
              <div className="relative h-28" style={{ background:'var(--brand-color)' }}>
                <div aria-hidden className="absolute inset-0 opacity-20" style={{ backgroundImage:'radial-gradient(#fff 1px, transparent 1px)', backgroundSize:'10px 10px' }}></div>
                <div className="absolute right-3 bottom-3 text-4xl select-none" aria-hidden>{c.emoji}</div>
              </div>
              <div className="px-3 py-3">
                <div className="text-xs uppercase tracking-wide text-slate-500">{c.tag}</div>
                <div className="font-medium text-slate-900">{c.title}</div>
              </div>
            </button>
          ))}
        </div>
      );
    }

    // Detailed club page view
    function ClubView({ name }){
      const storageKey = `unicon_club:${name}`;
      const [posts, setPosts] = React.useState(()=>{ try{ return JSON.parse(localStorage.getItem(storageKey)||'null') || []; }catch{ return []; } });
      React.useEffect(()=>{ try{ localStorage.setItem(storageKey, JSON.stringify(posts)); }catch{} }, [posts, storageKey]);
      const [text, setText] = React.useState('');
      const [tag, setTag] = React.useState('All');
      const [link, setLink] = React.useState('');
      const [mode, setMode] = React.useState('text'); // text|link|poll
      const [poll, setPoll] = React.useState({ q:'', a:'', b:'' });
      const [activeFilter, setActiveFilter] = React.useState('All');
      const lastKey = `unicon_last_post:club:${name}`;
      const [sortBy, setSortBy] = React.useState('Latest');
      function canPost(){ try{ const last=Number(localStorage.getItem(lastKey)||'0'); return (Date.now()-last) > 60000; }catch{ return true; } }
      function markPosted(){ try{ localStorage.setItem(lastKey, String(Date.now())); }catch{} }
      function add(){
        if(mode==='text' && !text.trim()) return;
        if(mode==='link' && !link.trim()) return;
        if(!canPost()) { const last=Number(localStorage.getItem(lastKey)||'0'); const remain=Math.max(0,60-Math.floor((Date.now()-last)/1000)); toast(`Please wait ${remain}s before posting again.`,'error'); return; }
        const id=String(Date.now());
        const base={ id, created:Date.now(), tag:(tag==='All'?'General':tag), pinned:false, hidden:false };
        const item = mode==='link' ? { ...base, text, link } : (mode==='poll' ? { ...base, poll } : { ...base, text });
        setPosts([ item, ...posts ]);
        markPosted(); toast('Post published','success');
        setText(''); setLink(''); setPoll({q:'',a:'',b:''});
      }

      const filters = ['All','Announcements','Accountability','Code Help','Events'];
      const [moreOpen, setMoreOpen] = React.useState(false);
      const [joined, setJoined] = React.useState(()=>{ try{ const m=JSON.parse(localStorage.getItem('unicon_memberships')||'{}'); return !!m[`club:${name}`]; }catch{ return false; } });
      function toggleJoin(){ setJoined(j=>{ const next=!j; try{ const m=JSON.parse(localStorage.getItem('unicon_memberships')||'{}'); m[`club:${name}`]=next; localStorage.setItem('unicon_memberships', JSON.stringify(m)); }catch{} return next; }); }

      return (
        <div className="grid lg:grid-cols-[1fr_320px] gap-3">
          <div className="space-y-3">
            <div className="rounded-xl border border-slate-200 bg-white p-2 flex items-center justify-between">
              <div className="text-sm text-slate-600">{name} • Club</div>
              <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="rounded-full border border-slate-300 px-2 py-1 text-sm">
                <option>Latest</option>
                <option>Oldest</option>
                <option>Pinned First</option>
              </select>
            </div>
            <div className="rounded-xl border border-slate-200 bg-white p-2 flex items-center gap-2 overflow-x-auto">
              {['CS Courses','Learn Java','Learn C','Learn C++'].map(tag=> (
                <span key={tag} className="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs border border-slate-200 bg-slate-50 text-slate-700">{tag}</span>
              ))}
            </div>

            <div className="rounded-2xl border border-slate-200 bg-white p-4">
              <div className="rounded-xl overflow-hidden border border-slate-200">
                <div className="relative h-40" style={{ background:'#f7efe6' }}>
                  <div aria-hidden className="absolute inset-0 opacity-30" style={{ backgroundImage:'radial-gradient(#0b0b0b 1px, transparent 1px)', backgroundSize:'10px 10px' }}></div>
                  <div className="absolute left-6 top-6 grid place-items-center h-10 w-10 rounded-full bg-white border border-slate-200 text-slate-900">👥</div>
                  <div className="absolute left-24 top-10 right-6 rounded-xl px-6 py-6 text-white" style={{ background:'var(--brand-color)' }}>
                    <div className="text-3xl font-extrabold tracking-wide uppercase">{name}</div>
                    <span className="mt-2 inline-block text-xs font-semibold tracking-wide px-3 py-1 rounded-lg" style={{ background:'#f6a9d7', color:'#111' }}>CLUB</span>
                    <button onClick={toggleJoin} className={`ml-3 align-middle rounded-full px-3 py-1 text-xs ${joined?'text-green-700 bg-green-50 border border-green-200':'bg-white/90 text-slate-900'}`}>{joined?'Joined':'Join'}</button>
                  </div>
                </div>
              </div>
            </div>

            <div className="flex flex-wrap gap-2 px-1">
              {filters.map(f=> (
                <button aria-pressed={activeFilter===f} onClick={()=>setActiveFilter(f)} key={f} className={`rounded-full px-4 py-2 text-sm border ${activeFilter===f? 'chip-brand' : 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50'}`}>{f}</button>
              ))}
              <button onClick={()=>setMoreOpen(o=>!o)} className="rounded-full px-3 py-2 text-sm border border-slate-200 bg-white text-slate-700">More ▾</button>
              {moreOpen && (
                <div className="w-full flex flex-wrap gap-2">
                  {['Projects','Resources','Study Groups','Jobs'].map(f=> (
                    <button aria-pressed={activeFilter===f} onClick={()=>setActiveFilter(f)} key={f} className={`rounded-full px-4 py-2 text-sm border ${activeFilter===f? 'chip-brand' : 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50'}`}>{f}</button>
                  ))}
                </div>
              )}
            </div>

            <div className="rounded-xl border border-slate-200 bg-white p-3">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2 text-slate-700"><span className="text-lg">🧩</span><span className="font-medium">Start a post</span></div>
                <div className="flex items-center gap-2">
                  <select value={tag} onChange={e=>setTag(e.target.value)} className="rounded-full border border-slate-300 px-3 py-1 text-sm">
                    {['All','Announcements','Accountability','Code Help','Events','Projects','Resources','Study Groups','Jobs'].map(f=> <option key={f}>{f}</option>)}
                  </select>
                  <select aria-label="Post type" value={mode} onChange={e=>setMode(e.target.value)} className="rounded-full border border-slate-300 px-3 py-1 text-sm">
                    <option value="text">Text</option>
                    <option value="link">Link</option>
                    <option value="poll">Poll</option>
                  </select>
                </div>
              </div>
              {mode==='text' && (
                <div className="flex gap-2">
                  <input value={text} onChange={e=>setText(e.target.value)} placeholder="Share something with the club…" className="flex-1 rounded-full border border-slate-300 bg-slate-50 px-4 py-2"/>
                  <button onClick={add} className="rounded-lg px-3 py-2 text-sm btn-brand">Post</button>
                </div>
              )}
              {mode==='link' && (
                <div className="grid md:grid-cols-[1fr_auto] gap-2 items-center">
                  <input value={text} onChange={e=>setText(e.target.value)} placeholder="Optional description" className="rounded-full border border-slate-300 px-3 py-2"/>
                  <input value={link} onChange={e=>setLink(e.target.value)} placeholder="https://link.example" className="rounded-full border border-slate-300 px-3 py-2"/>
                  <div className="md:col-span-2"><button onClick={add} className="rounded-lg px-3 py-2 text-sm btn-brand">Share link</button></div>
                </div>
              )}
              {mode==='poll' && (
                <div className="grid gap-2">
                  <input value={poll.q} onChange={e=>setPoll({...poll,q:e.target.value})} placeholder="Ask a question" className="rounded-full border border-slate-300 px-3 py-2"/>
                  <div className="grid md:grid-cols-2 gap-2">
                    <input value={poll.a} onChange={e=>setPoll({...poll,a:e.target.value})} placeholder="Option A" className="rounded-full border border-slate-300 px-3 py-2"/>
                    <input value={poll.b} onChange={e=>setPoll({...poll,b:e.target.value})} placeholder="Option B" className="rounded-full border border-slate-300 px-3 py-2"/>
                  </div>
                  <button onClick={add} className="rounded-lg px-3 py-2 text-sm btn-brand w-max">Post poll</button>
                </div>
              )}
            </div>

            <div className="rounded-2xl border border-slate-200 bg-white p-5 space-y-3">
              <div className="text-xl font-bold">About the {name} Club</div>
              <p className="text-slate-700">Welcome to our {name} Club. This space brings learners together for code help, projects, and events. With wide‑ranging applications from mobile apps to embedded systems, there’s a place here for everyone.</p>
              <p className="text-slate-700">Ask questions, share your wins, and collaborate. Be respectful, stay curious, and help others grow.</p>
            </div>

            <div className="space-y-3">
              {posts
                .filter(p=> activeFilter==='All' || (p.tag||'General')===activeFilter)
                .sort((a,b)=> sortBy==='Pinned First' ? ((b.pinned?1:0)-(a.pinned?1:0)) : (sortBy==='Oldest' ? (a.created-b.created) : (b.created-a.created)))
                .map(p=> (
                <div key={p.id} className="rounded-xl border border-slate-200 bg-white p-4">
                  {!p.hidden && (
                    <>
                      {p.text && <div className="text-slate-800">{p.text}</div>}
                      {p.link && <a href={p.link} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline break-all">{p.link}</a>}
                      {p.poll && (<ClubPoll poll={p.poll} pid={p.id} storageKey={storageKey} />)}
                      <div className="mt-2 text-xs text-slate-500 flex items-center justify-between">
                        <span>{new Date(p.created).toLocaleString()} • {(p.tag||'General')}</span>
                        <span className="flex items-center gap-2">
                          <button title={p.pinned?'Unpin':'Pin'} onClick={()=> setPosts(arr=> arr.map(x=> x.id===p.id? {...x, pinned:!x.pinned }: x))} className="hover:underline">{p.pinned?'Unpin':'Pin'}</button>
                          <button onClick={()=> setPosts(arr=> arr.map(x=> x.id===p.id? {...x, hidden:true }: x))} className="hover:underline">Hide</button>
                        </span>
                      </div>
                    </>
                  )}
                  {p.hidden && <div className="text-xs text-slate-500">Post hidden</div>}
                </div>
              ))}
            </div>
          </div>

          <aside className="space-y-3">
            <div className="rounded-2xl border border-slate-200 bg-white p-4">
              <div className="font-semibold mb-2">Members</div>
              <details className="text-sm text-slate-800">
                <summary className="cursor-pointer select-none">View member list</summary>
                <ul className="mt-2 space-y-2">
                  {['Dani Tellini','Steve S. Lee','mtf','Sean K','Gl1tch 4_J','Alan_Pickle'].map((m,i)=> (
                    <li key={m} className="flex items-center gap-3"><span className="h-8 w-8 rounded-full bg-slate-200 grid place-items-center">{String(m).slice(0,1)}</span><span className="flex-1 truncate">{m}</span>{i<2 && <span className="text-[10px] bg-slate-900 text-white rounded px-1">M</span>}</li>
                  ))}
                </ul>
              </details>
              <button onClick={toggleJoin} className="mt-3 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm hover:bg-slate-50">{joined?'Leave club':'Join club'}</button>
            </div>
          </aside>
        </div>
      );
    }

    // Department view: banner + clubs grid + department feed
    function DepartmentView({ name, clubs, posts, onPost, onRemove, onOpenClub }){
      return (
        <div className="space-y-3">
          <div className="rounded-2xl border border-slate-200 bg-white p-4">
            <div className="rounded-xl overflow-hidden border border-slate-200">
              <div className="relative h-36" style={{ background:'#f7efe6' }}>
                <div aria-hidden className="absolute inset-0 opacity-30" style={{ backgroundImage:'radial-gradient(#0b0b0b 1px, transparent 1px)', backgroundSize:'10px 10px' }}></div>
                <div className="absolute left-6 top-6 grid place-items-center h-10 w-10 rounded-full bg-white border border-slate-200 text-slate-900">🏫</div>
                <div className="absolute left-24 top-10 right-6 rounded-xl px-6 py-4 text-white" style={{ background:'var(--brand-color)' }}>
                  <div className="text-2xl font-extrabold tracking-wide">{name}</div>
                  <div className="text-xs opacity-90">Department</div>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl border border-slate-200 p-4">
            <div className="font-semibold mb-3">Clubs in {name}</div>
            <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
              {clubs.map(c=> (
                <button key={c} onClick={()=>onOpenClub(c)} className="text-left rounded-xl overflow-hidden border border-slate-200 bg-white hover:shadow transition-shadow">
                  <div className="h-20 relative" style={{ background:'var(--brand-color)' }}>
                    <div className="absolute right-3 bottom-3 text-white/90">👥</div>
                  </div>
                  <div className="px-3 py-3 font-medium text-slate-900 flex items-center justify-between">
                    <span>{c}</span>
                    <span className="text-[10px] text-slate-500">Club</span>
                  </div>
                </button>
              ))}
            </div>
          </div>

          <div className="rounded-2xl border border-slate-200 bg-white p-4">
            <div className="font-semibold mb-2">Department Feed</div>
            <SpaceComposer onPost={(t,m)=>onPost(t,m)} />
            <div className="mt-3 space-y-3">
              {posts.map(p=> (
                <div key={p.id} className="rounded-xl border border-slate-200 bg-white p-4">
                  {p.text && <div className="text-slate-800">{p.text}</div>}
                  {p.media && <div className="mt-2"><img src={p.media} alt="media" className="max-h-72 rounded-lg object-cover"/></div>}
                  <div className="mt-2 text-xs text-slate-500 flex items-center justify-between"><span>{new Date(p.created).toLocaleString()}</span><button onClick={()=>onRemove(p.id)} className="hover:underline">Delete</button></div>
                </div>
              ))}
              {posts.length===0 && <div className="text-sm text-slate-500">No posts yet in this department.</div>}
            </div>
          </div>
        </div>
      );
    }

    // Live Study rooms (local-only presence)
    function LiveStudy(){
      const key = 'unicon_study_rooms';
      const me = localStorage.getItem('uniconSessionEmail') || 'You';
      const [rooms, setRooms] = React.useState(()=>{ try{ return JSON.parse(localStorage.getItem(key)||'null') || [ { id:'r1', name:'Quiet Focus', topic:'Pomodoro 25/5', members:[] }, { id:'r2', name:'Algorithms', topic:'DS&A practice', members:[] } ]; }catch{ return []; } });
      React.useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(rooms)); }catch{} }, [rooms]);
      const [name, setName] = React.useState('');
      const [topic, setTopic] = React.useState('Study together');
      const [active, setActive] = React.useState('');
      function create(){ if(!name.trim()) return; const id=String(Date.now()); setRooms([{ id, name, topic, members:[me] }, ...rooms]); setName(''); setTopic('Study together'); setActive(id); }
      function toggle(id){ setRooms(rs=> rs.map(r=> r.id===id ? { ...r, members: r.members.includes(me) ? r.members.filter(x=>x!==me) : [...r.members, me] } : r)); }
      const current = rooms.find(r=> r.id===active);
      return (
        <div className="space-y-4">
          {!active && (
            <>
              <div className="rounded-2xl border border-slate-200 bg-white p-4">
                <div className="font-semibold mb-2">Create a study room</div>
                <div className="grid md:grid-cols-3 gap-2">
                  <input value={name} onChange={e=>setName(e.target.value)} placeholder="Room name" className="rounded-lg border border-slate-300 px-3 py-2"/>
                  <input value={topic} onChange={e=>setTopic(e.target.value)} placeholder="Topic / goal" className="rounded-lg border border-slate-300 px-3 py-2"/>
                  <button onClick={create} className="rounded-lg px-3 py-2 text-sm btn-brand">Create</button>
                </div>
              </div>
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                {rooms.map(r=> (
                  <div key={r.id} className="rounded-2xl border border-slate-200 bg-white p-4 flex flex-col">
                    <div className="font-semibold text-slate-900">{r.name}</div>
                    <div className="text-sm text-slate-600">{r.topic}</div>
                    <div className="mt-2 flex -space-x-2">
                      {r.members.slice(0,5).map(m=> (<span key={m} className="h-7 w-7 rounded-full bg-slate-200 border border-white grid place-items-center text-xs" title={m}>{String(m).slice(0,1)}</span>))}
                      {r.members.length===0 && <span className="text-xs text-slate-500">No one here yet</span>}
                    </div>
                    <div className="mt-3 flex items-center justify-between">
                      <span className="text-xs text-slate-500">{r.members.length} studying</span>
                      <div className="flex items-center gap-2">
                        <button onClick={()=>toggle(r.id)} className={`rounded-full px-3 py-1 text-sm ${r.members.includes(me)?'text-green-700 bg-green-50 border border-green-200':'btn-brand'}`}>{r.members.includes(me)?'Joined':'Join'}</button>
                        {r.members.includes(me) && <button onClick={()=>setActive(r.id)} className="rounded-full px-3 py-1 text-sm border border-slate-200">Open</button>}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}

          {active && current && (
            <RoomView room={current} me={me} onLeave={()=>{ setActive(''); toggle(current.id); }} />
          )}
        </div>
      );
    }

    function RoomView({ room, me, onLeave }){
      const chan = React.useRef(null);
      const [msgs, setMsgs] = React.useState([]);
      const [text, setText] = React.useState('');
      React.useEffect(()=>{
        try{ chan.current = new BroadcastChannel(`unicon_room_${room.id}`); chan.current.onmessage = (e)=> setMsgs(m=> [...m, e.data]); }catch{}
        return ()=>{ try{ chan.current && chan.current.close(); }catch{} };
      }, [room.id]);
      function send(){ if(!text.trim()) return; const m={ id:String(Date.now()), from:me, text, t:Date.now() }; setMsgs(s=>[...s,m]); try{ chan.current && chan.current.postMessage(m); }catch{} setText(''); }
      // simple timer
      const [sec, setSec] = React.useState(25*60);
      const [running, setRunning] = React.useState(false);
      React.useEffect(()=>{ if(!running) return; const id=setInterval(()=> setSec(s=> s>0? s-1 : 0), 1000); return ()=> clearInterval(id); }, [running]);
      function resetTimer(m){ setSec(m*60); setRunning(false); }
      const mm = String(Math.floor(sec/60)).padStart(2,'0');
      const ss = String(sec%60).padStart(2,'0');
      const notesKey = `unicon_room_notes:${room.id}:${me}`;
      const [notes, setNotes] = React.useState(()=> store.get(notesKey,'') );
      React.useEffect(()=>{ store.set(notesKey, notes); }, [notes]);
      return (
        <div className="grid lg:grid-cols-[1fr_320px] gap-3">
          <section className="rounded-2xl border border-slate-200 bg-white p-4">
            <div className="flex items-center justify-between mb-2">
              <div>
                <div className="text-xl font-semibold">{room.name}</div>
                <div className="text-sm text-slate-600">{room.topic}</div>
              </div>
              <button onClick={onLeave} className="rounded-full px-3 py-1 text-sm border border-slate-200">Leave</button>
            </div>
            <div className="grid md:grid-cols-[200px_1fr] gap-3">
              <div className="rounded-xl border border-slate-200 p-3 grid place-items-center">
                <div className="text-3xl font-bold" style={{color:'var(--brand-color)'}}>{mm}:{ss}</div>
                <div className="mt-2 flex gap-2">
                  <button onClick={()=>setRunning(r=>!r)} className="rounded-full px-3 py-1 text-sm btn-brand">{running?'Pause':'Start'}</button>
                  <button onClick={()=>resetTimer(25)} className="rounded-full px-3 py-1 text-sm border">25</button>
                  <button onClick={()=>resetTimer(5)} className="rounded-full px-3 py-1 text-sm border">5</button>
                </div>
              </div>
              <div className="rounded-xl border border-slate-200 p-3 flex flex-col min-h-[240px]">
                <div className="flex-1 overflow-auto space-y-2 pr-1">
                  {msgs.map(m=> (<div key={m.id} className={`max-w-[80%] rounded-lg px-3 py-2 ${m.from===me? 'ml-auto bg-[var(--brand-color)] text-white' : 'bg-slate-100'}`}>{m.text}</div>))}
                </div>
                <div className="mt-2 flex gap-2"><input value={text} onChange={e=>setText(e.target.value)} onKeyDown={e=>{ if(e.key==='Enter') send(); }} placeholder="Write a message" className="flex-1 rounded-full border border-slate-300 px-3 py-2"/><button onClick={send} className="rounded-full px-4 py-2 btn-brand">Send</button></div>
              </div>
            </div>
          </section>
          <aside className="rounded-2xl border border-slate-200 bg-white p-3">
            <div className="font-semibold mb-2">Notes</div>
            <textarea value={notes} onChange={e=>setNotes(e.target.value)} rows="10" className="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="Write personal study notes here"></textarea>
          </aside>
        </div>
      );
    }

    function SpaceComposer({ onPost }){
      const [text, setText] = useState('');
      const [media, setMedia] = useState('');
      const ref = React.useRef(null);
      async function changeMedia(e){ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); const data = await new Promise(res=>{ r.onload=()=>res(r.result); r.readAsDataURL(f); }); const small = await compressImage(data, 1600); setMedia(small); }
      function submit(){ if(!text.trim() && !media) return; onPost(text, media); setText(''); setMedia(''); if(ref.current) ref.current.value=''; }
      return (
        <div className="rounded-2xl border border-slate-200 bg-white p-4">
          <div className="grid md:grid-cols-[1fr_auto] gap-2 items-center">
            <input value={text} onChange={e=>setText(e.target.value)} placeholder="Share something with your department…" className="rounded-full border border-slate-200 bg-slate-50 px-4 py-2"/>
            <div className="flex items-center gap-2">
              <input ref={ref} type="file" accept="image/*" onChange={changeMedia} />
              <button onClick={submit} className="rounded-full px-4 py-2 btn-brand">Post</button>
            </div>
          </div>
          {media && <div className="mt-3"><img src={media} className="max-h-56 rounded-lg object-cover" alt="preview"/></div>}
        </div>
      );
    }
    function PostBox({ onSubmit }){
      const [t, setT] = useState('');
      return (
        <div className="flex gap-2">
          <input value={t} onChange={e=>setT(e.target.value)} placeholder="Write a post…" className="flex-1 rounded-lg border border-slate-300 px-3 py-2" />
          <button onClick={()=>{ onSubmit(t); setT(''); }} className="rounded-lg px-3 py-2 text-sm btn-brand">Post</button>
        </div>
      );
    }

    function Marketplace(){
      // Seed data
      const defaults = [
        { id:'1', title:'USP Hoodie', price:45, verified:true, category:'Apparel', condition:'New', seller:'USP Store', contact:'store@usp.edu', desc:'Official campus hoodie. Sizes S-XL.', images:[], sold:false },
        { id:'2', title:'Calculus Textbook', price:35, verified:false, category:'Textbooks', condition:'Used - Good', seller:'Alex', contact:'alex@example.com', desc:'Stewart Calculus 8th Edition.', images:[], sold:false },
      ];
      const sessionEmail = localStorage.getItem('uniconSessionEmail') || '';
      let profName = 'You';
      try { const p = JSON.parse(localStorage.getItem('uniconProfile')||'null'); if(p?.name) profName = p.name; } catch {}
      // State
      const [items, setItems] = useState(()=>{ 
        try{ 
          const raw = JSON.parse(localStorage.getItem('unicon_market')||'null') || defaults; 
          return raw.map(i=> i.images? i : { ...i, images: i.img? [i.img] : [] });
        }catch{ return defaults; } 
      });
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_market', JSON.stringify(items)); }catch{} }, [items]);
      const f0 = (()=>{ try{ return JSON.parse(localStorage.getItem('unicon_market_filters')||'null')||{}; }catch{ return {}; } })();
      const [query, setQuery] = useState(()=>{ try{ const cmdq=localStorage.getItem('unicon_market_cmd_query'); if(cmdq){ localStorage.removeItem('unicon_market_cmd_query'); return cmdq; } return f0.query||''; }catch{ return ''; } });
      const [cat, setCat] = useState(f0.cat||'All');
      const [cond, setCond] = useState(f0.cond||'All');
      const [minP, setMinP] = useState(f0.minP||'');
      const [maxP, setMaxP] = useState(f0.maxP||'');
      const [onlyV, setOnlyV] = useState(!!f0.onlyV);
      const [sortBy, setSortBy] = useState(f0.sortBy||'Newest');
      const [onlySaved, setOnlySaved] = useState(!!f0.onlySaved);
      const [onlyMine, setOnlyMine] = useState(!!f0.onlyMine);
      const [visible, setVisible] = useState(12);
      const [wish, setWish] = useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_market_wish')||'null')||{}; }catch{ return {}; } });
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_market_wish', JSON.stringify(wish)); }catch{} }, [wish]);
      const [view, setView] = useState(null); // current item for modal

      const categories = ['All','Textbooks','Study Materials','Calculators','Lab Equipment','Apparel','Electronics','Furniture','Dorm Essentials','Tickets','Rideshare','Tutoring','Other'];
      const conditions = ['All','New','Like New','Used - Good','Used - Fair'];
      const locations = ['Any','Main Library','Student Center','Cafeteria','Gym Lobby','Dorm A Lobby','Admin Building','North Gate','South Gate'];
      const payments = ['Cash','Bank Transfer','Campus Card'];

      // Helpers
      const fmt = (n)=> new Intl.NumberFormat(undefined,{ style:'currency', currency:'USD', maximumFractionDigits:0 }).format(Number(n||0));
      const contactHref = (c)=> String(c||'').includes('@')? `mailto:${c}` : `tel:${c}`;

      // Create listing
      const [form, setForm] = useState({ title:'', price:'', category:'Textbooks', condition:'Used - Good', seller:profName, contact:sessionEmail, desc:'', images:[], location:'Main Library', payment:'Cash', meta:{} });
      const imgRef = React.useRef(null);
      async function onImg(e){ const files = Array.from(e.target.files||[]).slice(0,4); if(files.length===0) return; const readers = files.map(f=> new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); })); const imgs = await Promise.all(readers); const compressed = await Promise.all(imgs.map(src=> compressImage(src, 1600))); setForm(f=> ({...f, images: [...(f.images||[]), ...compressed].slice(0,4)})); }
      function add(){ if(!form.title.trim()) return; const id=String(Date.now()); const verifiedAuto = /@[^\s]+\.edu$/.test(String(form.contact||'')); const postedAt=Date.now(); setItems([{ id, ...form, price:Number(form.price)||0, verified: verifiedAuto, sold:false, postedAt }, ...items]); setForm({ title:'', price:'', category:'Textbooks', condition:'Used - Good', seller:profName, contact:sessionEmail, desc:'', images:[], location:'Main Library', payment:'Cash', meta:{} }); if(imgRef.current) imgRef.current.value=''; }

      // Filtering + sort
      const [loc, setLoc] = useState(f0.loc||'Any');
      const [onlyAvail, setOnlyAvail] = useState(f0.onlyAvail===undefined? true : !!f0.onlyAvail);
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_market_filters', JSON.stringify({ query, cat, cond, minP, maxP, onlyV, sortBy, onlySaved, onlyMine, loc, onlyAvail })); }catch{} }, [query, cat, cond, minP, maxP, onlyV, sortBy, onlySaved, onlyMine, loc, onlyAvail]);
      const filtered = items
        .filter(i=> (cat==='All'||i.category===cat))
        .filter(i=> (cond==='All'||i.condition===cond))
        .filter(i=> (query? (i.title+" "+(i.desc||'')).toLowerCase().includes(query.toLowerCase()) : true))
        .filter(i=> (minP!==''? i.price>=Number(minP) : true) && (maxP!==''? i.price<=Number(maxP) : true))
        .filter(i=> (onlyV? !!i.verified : true))
        .filter(i=> (loc==='Any' ? true : i.location===loc))
        .filter(i=> (onlyAvail ? !i.sold : true))
        .filter(i=> (!onlySaved || !!wish[i.id]))
        .filter(i=> (!onlyMine || String(i.contact||'')===sessionEmail))
        .sort((a,b)=> sortBy==='Price: Low' ? (a.price-b.price) : sortBy==='Price: High' ? (b.price-a.price) : sortBy==='Verified' ? ((b.verified?1:0)-(a.verified?1:0)) : (Number(b.id)-Number(a.id)) );

      function toggleWish(id){ setWish(w=> ({ ...w, [id]: !w[id] })); }
      function markSold(id){ setItems(arr=> arr.map(i=> i.id===id ? { ...i, sold:true } : i)); }

      // skeleton loading
      const [loading, setLoading] = useState(true);
      React.useEffect(()=>{ const id = (window.requestIdleCallback ? requestIdleCallback(()=>setLoading(false), {timeout:300}) : setTimeout(()=>setLoading(false), 200)); return ()=>{ try{ cancelIdleCallback && cancelIdleCallback(id); }catch{ clearTimeout(id); } }; }, []);
      return (
        <div className="space-y-4">
          {/* Header and filters */
          <div className="bg-white rounded-xl border border-slate-200 p-4">
            <div className="flex items-center justify-between gap-3">
              <div>
                <h2 className="text-2xl font-bold text-slate-900">Marketplace</h2>
                <p className="text-slate-600">Buy and sell within your campus.</p>
              </div>
              <div className="hidden md:flex items-center gap-2">
                <label className="text-sm text-slate-600">Sort</label>
                <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="rounded-full border border-slate-300 px-3 py-1 text-sm">
                  <option>Newest</option>
                  <option>Price: Low</option>
                  <option>Price: High</option>
                  <option>Verified</option>
                </select>
              </div>
            </div>
            <div className="mt-3 grid md:grid-cols-7 gap-2">
              <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search items" className="md:col-span-2 rounded-lg border border-slate-300 px-3 py-2"/>
              <select value={cat} onChange={e=>setCat(e.target.value)} className="rounded-lg border border-slate-300 px-3 py-2">
                {categories.map(c=> <option key={c}>{c}</option>)}
              </select>
              <select value={cond} onChange={e=>setCond(e.target.value)} className="rounded-lg border border-slate-300 px-3 py-2">
                {conditions.map(c=> <option key={c}>{c}</option>)}
              </select>
              <select value={loc} onChange={e=>setLoc(e.target.value)} className="rounded-lg border border-slate-300 px-3 py-2">
                {locations.map(c=> <option key={c}>{c}</option>)}
              </select>
              <input value={minP} onChange={e=>setMinP(e.target.value)} placeholder="Min price" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <input value={maxP} onChange={e=>setMaxP(e.target.value)} placeholder="Max price" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <label className="inline-flex items-center gap-2 text-sm px-2 py-2"><input type="checkbox" checked={onlyV} onChange={e=>setOnlyV(e.target.checked)}/><span>Verified only</span></label>
              <div className="md:col-span-6 flex flex-wrap gap-2 items-center">
                <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={onlySaved} onChange={e=>setOnlySaved(e.target.checked)}/><span>Saved</span></label>
                <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={onlyMine} onChange={e=>setOnlyMine(e.target.checked)}/><span>My listings</span></label>
                <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={onlyAvail} onChange={e=>setOnlyAvail(e.target.checked)}/><span>Only available</span></label>
                <button onClick={()=>{ setQuery(''); setCat('All'); setCond('All'); setMinP(''); setMaxP(''); setOnlyV(false); setOnlySaved(false); setOnlyMine(false); setSortBy('Newest'); }} className="text-sm rounded-full px-3 py-1 border">Reset</button>
              </div>
            </div>
          </div>

          /* Create listing */}
          <div className="bg-white rounded-xl border border-slate-200 p-4">
            <div className="font-medium mb-2">Create listing</div>
            <div className="grid md:grid-cols-6 gap-2">
              <input value={form.title} onChange={e=>setForm({...form, title:e.target.value})} placeholder="Item title" className="rounded-lg border border-slate-300 px-3 py-2 md:col-span-2"/>
              <input value={form.price} onChange={e=>setForm({...form, price:e.target.value})} placeholder="Price" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <select value={form.category} onChange={e=>setForm({...form, category:e.target.value, meta:{} })} className="rounded-lg border border-slate-300 px-3 py-2">
                {categories.filter(c=>c!=='All').map(c=> <option key={c}>{c}</option>)}
              </select>
              <select value={form.condition} onChange={e=>setForm({...form, condition:e.target.value})} className="rounded-lg border border-slate-300 px-3 py-2">
                {conditions.filter(c=>c!=='All').map(c=> <option key={c}>{c}</option>)}
              </select>
              <input value={form.seller} onChange={e=>setForm({...form, seller:e.target.value})} placeholder="Your name" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <input value={form.contact} onChange={e=>setForm({...form, contact:e.target.value})} placeholder="Email or phone" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <input ref={imgRef} type="file" accept="image/*" multiple onChange={onImg} className="md:col-span-2"/>
              <input value={form.desc} onChange={e=>setForm({...form, desc:e.target.value})} placeholder="Short description" className="md:col-span-3 rounded-lg border border-slate-300 px-3 py-2"/>
              <select value={form.location} onChange={e=>setForm({...form, location:e.target.value})} className="rounded-lg border border-slate-300 px-3 py-2">
                {locations.filter(l=>l!=='Any').map(l=> <option key={l}>{l}</option>)}
              </select>
              <select value={form.payment} onChange={e=>setForm({...form, payment:e.target.value})} className="rounded-lg border border-slate-300 px-3 py-2">
                {payments.map(p=> <option key={p}>{p}</option>)}
              </select>
              {/* Category-specific metadata */}
              {form.category==='Textbooks' && (
                <>
                  <input value={form.meta.course||''} onChange={e=>setForm({...form, meta:{...form.meta, course:e.target.value}})} placeholder="Course code (e.g., CS101)" className="rounded-lg border border-slate-300 px-3 py-2"/>
                  <input value={form.meta.isbn||''} onChange={e=>setForm({...form, meta:{...form.meta, isbn:e.target.value}})} placeholder="ISBN" className="rounded-lg border border-slate-300 px-3 py-2"/>
                </>
              )}
              {form.category==='Tickets' && (
                <>
                  <input value={form.meta.event||''} onChange={e=>setForm({...form, meta:{...form.meta, event:e.target.value}})} placeholder="Event name" className="rounded-lg border border-slate-300 px-3 py-2"/>
                  <input value={form.meta.date||''} onChange={e=>setForm({...form, meta:{...form.meta, date:e.target.value}})} placeholder="Event date" className="rounded-lg border border-slate-300 px-3 py-2"/>
                </>
              )}
              {form.category==='Rideshare' && (
                <>
                  <input value={form.meta.from||''} onChange={e=>setForm({...form, meta:{...form.meta, from:e.target.value}})} placeholder="From" className="rounded-lg border border-slate-300 px-3 py-2"/>
                  <input value={form.meta.to||''} onChange={e=>setForm({...form, meta:{...form.meta, to:e.target.value}})} placeholder="To" className="rounded-lg border border-slate-300 px-3 py-2"/>
                  <input value={form.meta.when||''} onChange={e=>setForm({...form, meta:{...form.meta, when:e.target.value}})} placeholder="Date & time" className="rounded-lg border border-slate-300 px-3 py-2 md:col-span-2"/>
                </>
              )}
              {form.category==='Tutoring' && (
                <input value={form.meta.subject||''} onChange={e=>setForm({...form, meta:{...form.meta, subject:e.target.value}})} placeholder="Subject (e.g., Calculus)" className="rounded-lg border border-slate-300 px-3 py-2"/>
              )}
              <div className="md:col-span-1"><button onClick={()=>{
                const errs=[]; if(!form.title.trim()) errs.push('Title'); if(!String(form.price).trim()) errs.push('Price'); if(!String(form.contact).trim()) errs.push('Contact');
                if(errs.length){ toast(`Missing: ${errs.join(', ')}`,'error'); return; }
                add();
              }} className="w-full rounded-lg px-3 py-2 text-sm btn-brand">Add</button></div>
            {form.images?.length>0 && (
              <div className="md:col-span-6 grid grid-cols-4 gap-2">
                {form.images.map((src,idx)=>(<img key={idx} src={src} alt={`preview-${idx}`} className="h-24 object-cover rounded-lg border"/>))}
              </div>
            )}
          </div>
        </div>

          {/* Listings */}
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
            {loading && [1,2,3,4,5,6].map(i=> (
              <div key={`sk-${i}`} className="rounded-xl border border-slate-200 overflow-hidden">
                <div className="h-40 skeleton"></div>
                <div className="p-4 space-y-2">
                  <div className="h-4 rounded skeleton"></div>
                  <div className="h-3 w-1/2 rounded skeleton"></div>
                </div>
              </div>
            ))}
            {filtered.slice(0,visible).map(i=> (
              <div key={i.id} className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                <div className="relative h-40 bg-slate-100 grid place-items-center cursor-pointer" onClick={()=>setView(i)}>
                  {(i.images&&i.images[0]) ? (<img src={i.images[0]} alt={i.title} className="h-full w-full object-cover"/>) : (<span className="text-slate-400">No image</span>)}
                  {i.verified && <span className="absolute top-2 left-2 text-[10px] bg-green-600 text-white rounded px-2 py-0.5">Verified</span>}
                  {i.sold && <span className="absolute top-2 right-2 text-[10px] bg-slate-900 text-white rounded px-2 py-0.5">Sold</span>}
                </div>
                <div className="p-4">
                  <div className="flex items-start justify-between gap-2">
                    <div className="font-semibold leading-tight">
                      <div className="truncate" title={i.title}>{i.title}</div>
                      <div className="text-slate-600">{fmt(i.price)}</div>
                    </div>
                    <button onClick={()=>toggleWish(i.id)} className={`h-8 w-8 rounded-full border grid place-items-center ${wish[i.id]? 'bg-[var(--brand-color)] text-white' : ''}`} title="Save">♥</button>
                  </div>
                  <div className="text-xs text-slate-500 flex items-center gap-2 flex-wrap">
                    <span>{i.category}</span>
                    <span className="inline-block rounded-full px-2 py-0.5 border text-[10px]">{i.condition}</span>
                    {i.location && <span className="inline-block rounded-full px-2 py-0.5 bg-slate-50 border text-[10px]">📍 {i.location}</span>}
                    {i.payment && <span className="inline-block rounded-full px-2 py-0.5 bg-slate-50 border text-[10px]">💳 {i.payment}</span>}
                  </div>
                  <div className="mt-2 flex items-center justify-between">
                    <div className="text-xs text-slate-500">by {i.seller} {i.postedAt && `• ${timeAgo(i.postedAt)}`}</div>
                    {i.contact && !i.sold && (
                      revealed[i.id] ? (
                        <a className="inline-block text-xs rounded-full px-3 py-1 btn-brand" href={contactHref(i.contact)}>Contact</a>
                      ) : (
                        <button onClick={()=>{ setRevealed(r=>({ ...r, [i.id]: true })); toast('Contact revealed','success'); }} className="inline-block text-xs rounded-full px-3 py-1 border">Reveal contact</button>
                      )
                    )}
                  </div>
                  {i.meta && Object.keys(i.meta).length>0 && (
                    <div className="mt-2 text-[11px] text-slate-600 flex gap-2 flex-wrap">
                      {i.meta.course && <span>Course: <strong>{i.meta.course}</strong></span>}
                      {i.meta.isbn && <span>ISBN: <strong>{i.meta.isbn}</strong></span>}
                      {i.meta.event && <span>Event: <strong>{i.meta.event}</strong></span>}
                      {i.meta.date && <span>Date: <strong>{i.meta.date}</strong></span>}
                      {i.meta.from && <span>From: <strong>{i.meta.from}</strong></span>}
                      {i.meta.to && <span>To: <strong>{i.meta.to}</strong></span>}
                      {i.meta.when && <span>When: <strong>{i.meta.when}</strong></span>}
                      {i.meta.subject && <span>Subject: <strong>{i.meta.subject}</strong></span>}
                    </div>
                  )}
                </div>
              </div>
            ))}
            {filtered.length===0 && <div className="text-sm text-slate-500">No items match your filters.</div>}
          </div>
          {visible<filtered.length && <div className="grid place-items-center"><button onClick={()=>setVisible(v=>v+12)} className="rounded-full px-4 py-2 border">Load more</button></div>}

          {/* Details modal */}
          {view && (
              <div className="fixed inset-0 z-50 bg-black/40 grid place-items-center p-3" role="dialog" aria-modal="true" onKeyDown={(e)=>{ if(e.key==='Escape') setView(null); }}>
              <div className="max-w-3xl w-full bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-modal">
                <div className="grid md:grid-cols-2">
                  <div className="bg-slate-100 h-72 md:h-full grid place-items-center relative">
                    {(view.images && view.images[0]) ? <img src={view.images[0]} alt={view.title} className="object-contain max-h-full"/> : <span className="text-slate-400">No image</span>}
                    {view.images?.length>1 && (
                      <div className="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-2">
                        {view.images.map((src,idx)=> (<img key={idx} src={src} alt={`thumb-${idx}`} className="h-10 w-10 object-cover rounded border bg-white" onClick={()=> setView(v=> ({...v, images:v.images, _i:idx}))}/>))}
                      </div>
                    )}
                  </div>
                  <div className="p-4 space-y-2">
                    <div className="flex items-start justify-between">
                      <div>
                        <div className="text-xl font-bold">{view.title}</div>
                        <div className="text-slate-600">{fmt(view.price)}</div>
                      </div>
                      <button onClick={()=>setView(null)} className="h-8 w-8 grid place-items-center rounded-full border">✕</button>
                    </div>
                    <div className="text-sm text-slate-600">{view.category} • {view.condition} {view.verified && '• Verified'}</div>
                    <EditableListing view={view} setView={setView} meEmail={sessionEmail} onSave={(next)=> setItems(arr=> arr.map(i=> i.id===next.id? next : i))} onDelete={(id)=> { setItems(arr=> arr.filter(i=> i.id!==id)); setView(null); }} onSold={(id)=> { markSold(id); setView(v=> ({...v, sold:true})); }} wish={wish} toggleWish={toggleWish} contactHref={contactHref} />
                    {!revealed[view.id] && view.contact && !view.sold && (
                      <div className="mt-2"><button onClick={()=>{ setRevealed(r=>({ ...r, [view.id]: true })); toast('Contact revealed','success'); }} className="rounded-full px-3 py-2 text-sm border">Reveal contact</button></div>
                    )}
                  </div>
                </div>
                <div className="p-3 text-[11px] text-slate-500 border-t">Safety tip: Meet in public places on campus. Never share sensitive information. Report suspicious activity to your student services.</div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function EditableListing({ view, setView, meEmail, onSave, onDelete, onSold, wish, toggleWish, contactHref }){
      const isMine = String(view.contact||'')===meEmail;
      const [edit, setEdit] = React.useState(false);
      const [draft, setDraft] = React.useState(view);
      React.useEffect(()=>{ setDraft(view); }, [view]);
      function save(){ onSave(draft); setView(draft); setEdit(false); }
      function copyContact(){ try{ navigator.clipboard.writeText(String(view.contact||'')); toast('Contact copied','success'); }catch{} }
      const reportKey = `unicon_market_reports`;
      const [reported, setReported] = React.useState(()=>{ try{ const r=JSON.parse(localStorage.getItem(reportKey)||'{}'); return !!r[view.id]; }catch{ return false; } });
      function doReport(){ setReported(true); try{ const r=JSON.parse(localStorage.getItem(reportKey)||'{}'); r[view.id]=true; localStorage.setItem(reportKey, JSON.stringify(r)); }catch{} toast('Report submitted','success'); }

      // Offers
      const offersKey = `unicon_market_offers:${view.id}`;
      const [offers, setOffers] = React.useState(()=>{ try{ return JSON.parse(localStorage.getItem(offersKey)||'null')||[]; }catch{ return []; } });
      React.useEffect(()=>{ try{ localStorage.setItem(offersKey, JSON.stringify(offers)); }catch{} }, [offers, offersKey]);
      const [offer, setOffer] = React.useState({ price: view.price, message:'' });
      function sendOffer(){ if(!offer.price) return; const o={ id:String(Date.now()), from:meEmail||'You', price:Number(offer.price)||0, message:offer.message||'', time:Date.now(), status:'sent' }; setOffers(arr=> [o, ...arr]); setOffer({ price:view.price, message:'' }); toast('Offer sent','success'); }
      function changeOffer(id, status){ setOffers(arr=> arr.map(o=> o.id===id? {...o, status}: o)); if(status==='accepted') onSold(view.id); }
      return (
        <div className="space-y-2">
          {!edit ? (
            <>
              <p className="text-sm text-slate-700">{view.desc||'No description provided.'}</p>
              <div className="flex flex-wrap items-center gap-2">
                {view.contact && !view.sold && <a className="rounded-full px-3 py-2 text-sm btn-brand" href={contactHref(view.contact)}>Contact seller</a>}
                <button onClick={copyContact} className="rounded-full px-3 py-2 text-sm border">Copy contact</button>
                {!view.sold && <button onClick={()=>onSold(view.id)} className="rounded-full px-3 py-2 text-sm border">Mark sold</button>}
                <button onClick={()=>toggleWish(view.id)} className={`rounded-full px-3 py-2 text-sm border ${wish[view.id]? 'bg-[var(--brand-color)] text-white border-transparent' : ''}`}>{wish[view.id]? 'Saved' : 'Save'}</button>
                {isMine && <button onClick={()=>setEdit(true)} className="rounded-full px-3 py-2 text-sm border">Edit</button>}
                {isMine && <button onClick={async()=>{ if(await confirmDialog('Delete this listing?')) onDelete(view.id); }} className="rounded-full px-3 py-2 text-sm border">Delete</button>}
                {!isMine && !reported && <button onClick={doReport} className="rounded-full px-3 py-2 text-sm border">Report</button>}
              </div>
              <div className="text-xs text-slate-500">Seller: {view.seller}</div>
              {!isMine && !view.sold && (
                <div className="mt-2 rounded-lg border border-slate-200 p-3">
                  <div className="font-medium mb-1">Make an offer</div>
                  <div className="grid md:grid-cols-[120px_1fr_auto] gap-2 items-center">
                    <input value={offer.price} onChange={e=>setOffer({...offer, price:e.target.value})} className="rounded-lg border border-slate-300 px-3 py-2"/>
                    <input value={offer.message} onChange={e=>setOffer({...offer, message:e.target.value})} placeholder="Message (optional)" className="rounded-lg border border-slate-300 px-3 py-2"/>
                    <button onClick={sendOffer} className="rounded-lg px-3 py-2 text-sm btn-brand">Send</button>
                  </div>
                </div>
              )}
              {isMine && (
                <div className="mt-2 rounded-lg border border-slate-200 p-3">
                  <div className="font-medium mb-1">Offers</div>
                  <div className="space-y-2">
                    {offers.length===0 && <div className="text-sm text-slate-500">No offers yet.</div>}
                    {offers.map(o=> (
                      <div key={o.id} className="flex items-center justify-between text-sm">
                        <div>
                          <div className="font-medium">{fmt(o.price)}</div>
                          <div className="text-xs text-slate-500">from {o.from||'Student'} • {timeAgo(o.time)} • {o.status}</div>
                          {o.message && <div className="text-slate-700">“{o.message}”</div>}
                        </div>
                        <div className="flex items-center gap-2">
                          <button onClick={()=>changeOffer(o.id,'accepted')} className="rounded-full px-3 py-1 text-xs border">Accept</button>
                          <button onClick={()=>changeOffer(o.id,'declined')} className="rounded-full px-3 py-1 text-xs border">Decline</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </>
          ) : (
            <div className="space-y-2">
              <textarea value={draft.desc||''} onChange={e=>setDraft({...draft, desc:e.target.value})} className="w-full rounded-lg border border-slate-300 px-3 py-2" rows="3"></textarea>
              <div className="grid grid-cols-2 gap-2">
                <input value={draft.price} onChange={e=>setDraft({...draft, price:Number(e.target.value)||0})} className="rounded-lg border border-slate-300 px-3 py-2"/>
                <input value={draft.contact||''} onChange={e=>setDraft({...draft, contact:e.target.value})} className="rounded-lg border border-slate-300 px-3 py-2"/>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={save} className="rounded-full px-3 py-2 text-sm btn-brand">Save</button>
                <button onClick={()=>{ setEdit(false); setDraft(view); }} className="rounded-full px-3 py-2 text-sm border">Cancel</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function timeAgo(t){ const s=Math.floor((Date.now()-t)/1000); if(s<60) return `${s}s ago`; const m=Math.floor(s/60); if(m<60) return `${m}m ago`; const h=Math.floor(m/60); if(h<24) return `${h}h ago`; const d=Math.floor(h/24); if(d<7) return `${d}d ago`; const w=Math.floor(d/7); if(w<4) return `${w}w ago`; const mon=Math.floor(d/30); if(mon<12) return `${mon}mo ago`; const y=Math.floor(d/365); return `${y}y ago`; }

    function Events(){
      const defaults = [
        { id:'e1', title:'Hack Club Meet', time:'Wed 4:00 PM', featured: true },
        { id:'e2', title:'Career Talk', time:'Fri 2:00 PM', featured: false },
      ];
      const [events, setEvents] = useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_events')||'null') || defaults; }catch{ return defaults; } });
      const [rsvp, setRsvp] = useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_rsvp')||'null') || {}; }catch{ return {}; } });
      const [title, setTitle] = useState('');
      const [time, setTime] = useState('');
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_events', JSON.stringify(events)); }catch{} }, [events]);
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_rsvp', JSON.stringify(rsvp)); }catch{} }, [rsvp]);
      const [err, setErr] = useState('');
      function add(){ if(!title.trim()||!time.trim()){ setErr('Title and date/time are required.'); toast('Please fill all fields','error'); return; } setErr(''); setEvents([{ id:String(Date.now()), title, time, featured:false }, ...events]); setTitle(''); setTime(''); toast('Event created','success'); }
      function toggle(id){ setRsvp(s=> ({ ...s, [id]: !s[id] })); }
      return (
        <div className="space-y-4">
          <div className="bg-white rounded-xl border border-slate-200 p-4">
            <div className="font-medium mb-2">Create event</div>
            <div className="grid md:grid-cols-3 gap-2">
              <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Event title" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <input value={time} onChange={e=>setTime(e.target.value)} placeholder="Date & time" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <button onClick={add} className="rounded-lg px-3 py-2 text-sm btn-brand">Add</button>
            </div>
            {err && <div className="text-xs text-red-700 mt-2">{err}</div>}
          </div>
          <div className="space-y-3">
            {events.map(ev=> (
              <div key={ev.id} className="flex items-center justify-between rounded-lg border p-3 bg-white border-slate-200">
                <div>
                  <div className="font-medium">{ev.title} — {ev.time}</div>
                  {ev.featured && <div className="text-xs text-amber-700">Featured</div>}
                </div>
                <button onClick={()=>toggle(ev.id)} className={`rounded-md px-2 py-1 text-xs ${rsvp[ev.id]? 'text-green-700 bg-green-50 border border-green-200':'btn-brand'}`}>{rsvp[ev.id]? 'Going' : 'RSVP'}</button>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // --- Calendar tab: month grid + recommended events ---
    function CalendarTab(){
      const [events, setEvents] = useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_events')||'null') || [];}catch{ return []; } });
      const [showImport, setShowImport] = useState(false);
      const [csv, setCsv] = useState('title,start,end,desc\nSemester Starts,2025-08-12,,Opening day\nMidterms Week,2025-10-06,2025-10-10,Exams\nSem Break,2025-10-27,2025-11-03,No classes');
      const today = new Date();
      const [view, setView] = useState(()=> new Date(today.getFullYear(), today.getMonth(), 1));
      const y = view.getFullYear();
      const m = view.getMonth();
      const first = new Date(y, m, 1);
      const startDay = first.getDay();
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const cells = [];
      for(let i=0;i<startDay;i++) cells.push(null);
      for(let d=1; d<=daysInMonth; d++) cells.push(new Date(y,m,d));
      const byDate = (date)=> events.filter(ev=> {
        const s = ev.start ? new Date(ev.start) : (ev.time? new Date(ev.time) : null);
        if(!s) return false;
        const e = ev.end ? new Date(ev.end) : s;
        const d0 = new Date(date.getFullYear(),date.getMonth(),date.getDate());
        const ds = new Date(s.getFullYear(),s.getMonth(),s.getDate());
        const de = new Date(e.getFullYear(),e.getMonth(),e.getDate());
        return d0>=ds && d0<=de;
      });
      const recs = events.slice(0,6);
      const fmtDate = (d)=> new Date(d).toLocaleDateString(undefined,{ month:'short', day:'2-digit', year:'numeric' });
      const formatRange = (ev)=>{
        if (ev.start){
          if (ev.end && ev.end!==ev.start){
            const s = new Date(ev.start); const e = new Date(ev.end);
            const sameMonth = s.getFullYear()===e.getFullYear() && s.getMonth()===e.getMonth();
            if (sameMonth){
              const mname = s.toLocaleString(undefined,{ month:'short' });
              return `${mname} ${String(s.getDate()).padStart(2,'0')}–${e.getDate()}, ${e.getFullYear()}`;
            }
            return `${fmtDate(ev.start)} – ${fmtDate(ev.end)}`;
          }
          return fmtDate(ev.start);
        }
        return ev.time || 'TBD';
      };
      const rawGcal = (()=>{ try { return localStorage.getItem('unicon_gcal_url') || ''; } catch { return ''; } })();
      const fallbackGcal = 'https://calendar.google.com/calendar/embed?src=en.philippines%23holiday%40group.v.calendar.google.com&ctz=Asia%2FManila&mode=MONTH&wkst=1&showTabs=0&showPrint=0&showCalendars=0';
      const gcalUrl = (()=>{ const base = rawGcal || fallbackGcal; return base.includes('hl=') ? base : base + (base.includes('?')?'&':'?') + 'hl=en'; })();
      const upcoming = events.filter(ev=>{
        const s = ev.start ? new Date(ev.start) : (ev.time? new Date(ev.time) : null);
        if(!s) return false; const now=new Date(); const diff=(s-now)/(1000*60*60*24); return diff>=0 && diff<=30;
      }).slice(0,8);
      return (
        <div className="space-y-4 grid lg:grid-cols-[1fr_320px] gap-3">
          {/* School Google Calendar embed */}
          <div className="rounded-2xl border border-slate-200 bg-white p-3">
            <div className="flex items-center justify-between mb-2">
              <div className="font-medium">School Google Calendar</div>
              <span className="text-xs text-slate-500">read‑only</span>
            </div>
            <div className="w-full overflow-hidden rounded-xl border">
              <iframe src={gcalUrl} style={{ border:0 }} width="100%" height="600" frameBorder="0" scrolling="no"></iframe>
            </div>
          </div>

          {/* Right list: upcoming */}
          <aside className="hidden lg:block space-y-3">
            <div className="rounded-2xl border border-slate-200 bg-white p-3">
              <div className="font-semibold">Next 30 days</div>
              <ul className="mt-2 space-y-2 text-sm">
                {upcoming.length? upcoming.map(ev=> (
                  <li key={ev.id} className="flex items-center justify-between"><span className="truncate" title={ev.title}>{ev.title}</span><span className="text-xs text-slate-500 ml-2">{formatRange(ev)}</span></li>
                )) : <li className="text-slate-600">No upcoming events</li>}
              </ul>
            </div>
          </aside>

          {/* Recommended community events */}
          <div className="lg:col-span-2">
            <div className="flex items-center justify-between mb-2"><h3 className="text-xl font-semibold">Recommended community events</h3><button className="text-sm text-[var(--brand-color)]">View all events →</button></div>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
              {recs.length? recs.map(ev=> (
                <div key={ev.id} className="rounded-xl border border-slate-200 bg-white p-4">
                  <div className="font-semibold text-slate-900">{ev.title}</div>
                  <div className="text-xs text-slate-600 mt-1">📅 {formatRange(ev)}</div>
                  <p className="text-sm text-slate-700 mt-2 line-clamp-3">{ev.desc || 'Campus activity'}</p>
                  <div className="mt-2 text-xs text-slate-500">👥 {Math.floor(Math.random()*80)+1}</div>
                </div>
              )) : (
                [1,2,3,4,5,6].map(i=> <div key={i} className="rounded-xl border border-slate-200 bg-white p-4"><div className="font-semibold">Community meetup</div><div className="text-xs text-slate-600 mt-1">TBD</div><p className="text-sm text-slate-700 mt-2">Join peers for a session.</p></div>)
              )}
            </div>
          </div>
        </div>
      );
    }

    // --- Profile with editable fields ---
    function Profile(){
      const [profile, setProfile] = useState(()=>{
        try { return JSON.parse(localStorage.getItem('uniconProfile')||'null') || { name:'Student User', email: localStorage.getItem('uniconSessionEmail'), bio:'', year:'', major:'', avatar:'👤' }; } catch { return { name:'Student User', email: localStorage.getItem('uniconSessionEmail'), bio:'', year:'', major:'', avatar:'👤' }; }
      });
      const [msg, setMsg] = useState('');
      const [showUserSettings, setShowUserSettings] = useState(false);
      const email = localStorage.getItem('uniconSessionEmail') || 'default';
      const storageKey = `unicon_profile_posts:${email}`;
      const [posts, setPosts] = useState(()=>{ try{ return JSON.parse(localStorage.getItem(storageKey)||'null') || []; }catch{ return []; } });
      React.useEffect(()=>{ try{ localStorage.setItem(storageKey, JSON.stringify(posts)); }catch{} }, [posts]);
      // Composer state
      const [postText, setPostText] = useState('');
      const [postMedia, setPostMedia] = useState('');
      const mediaRef = React.useRef(null);
      function update(field, value){ setProfile(p=>({ ...p, [field]: value })); }
      function save(){ try{ localStorage.setItem('uniconProfile', JSON.stringify(profile)); setMsg('Saved'); setTimeout(()=>setMsg(''), 1200);}catch{} }
      async function changeAvatar(e){ const f=e.target.files&&e.target.files[0]; if(!f) return; const data = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); }); const small = await compressImage(data, 1600); update('avatar', small); }
      const fileRef = React.useRef(null);
      function changeMedia(e){ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=> setPostMedia(r.result); r.readAsDataURL(f); }
      function submitPost(){ if(!postText.trim() && !postMedia) return; setPosts([{ id:String(Date.now()), text:postText, media:postMedia, created:new Date().toISOString() }, ...posts]); setPostText(''); setPostMedia(''); if(mediaRef.current) mediaRef.current.value=''; }
      function removePost(id){ setPosts(arr=> arr.filter(p=> p.id!==id)); }
      return (
        <div className="bg-white rounded-2xl border border-slate-200 p-5 space-y-4">
          <div className="flex items-start gap-4">
            <div className="relative h-16 w-16">
              {String(profile.avatar||'').startsWith('data:') ? (
                <img src={profile.avatar} className="h-16 w-16 rounded-full object-cover border border-slate-200" alt="avatar"/>
              ) : (
                <div className="h-16 w-16 rounded-full grid place-items-center text-2xl bg-slate-100 border border-slate-200" aria-hidden>{profile.avatar||'👤'}</div>
              )}
              <button type="button" onClick={()=>fileRef.current && fileRef.current.click()} title="Add photo" className="absolute -bottom-1 -right-1 h-7 w-7 rounded-full btn-brand grid place-items-center text-base leading-none shadow ring-2 ring-white">+</button>
              <input ref={fileRef} type="file" accept="image/*" onChange={changeAvatar} className="hidden" />
            </div>
            <div className="flex-1 grid md:grid-cols-2 gap-3">
              <label className="block text-sm">Full name<input value={profile.name||''} onChange={e=>update('name', e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"/></label>
              <label className="block text-sm">Email<input disabled value={profile.email||''} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-slate-50"/></label>
              <label className="block text-sm">Year<input value={profile.year||''} onChange={e=>update('year', e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"/></label>
              <label className="block text-sm">Major<input value={profile.major||''} onChange={e=>update('major', e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"/></label>
              <label className="block text-sm md:col-span-2">Bio<textarea value={profile.bio||''} onChange={e=>update('bio', e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" rows="3"/></label>
              <div className="text-xs text-slate-500 md:col-span-2">Tip: click the + on your avatar to upload a photo.</div>
            </div>
          </div>
          {msg && <div className="text-sm text-green-700 bg-green-50 border border-green-200 rounded-xl px-3 py-2 inline-block">{msg}</div>}
          <div className="flex items-center justify-between pt-2">
            <button onClick={save} className="rounded-xl px-4 py-2 btn-brand">Save changes</button>
            <button onClick={()=>setShowUserSettings(true)} className="rounded-xl px-3 py-2 border border-slate-300 text-sm">Settings & privacy</button>
          </div>

          {showUserSettings && (
            <div className="fixed inset-0 bg-black/30 grid place-items-center z-50">
              <div className="w-full max-w-lg bg-white rounded-2xl p-4 border border-slate-200">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-lg font-semibold">Settings & privacy</h3>
                  <button onClick={()=>setShowUserSettings(false)} className="text-slate-600">✕</button>
                </div>
                <div className="mb-3">
                  <input placeholder="Search settings" className="w-full rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-sm" />
                </div>
                <div className="space-y-4 max-h-[70vh] overflow-auto pr-1">
                  <div>
                    <div className="text-xs font-semibold text-slate-500 mb-1">Preferences</div>
                    <div className="divide-y divide-slate-200 rounded-xl border border-slate-200">
                      <div className="flex items-center justify-between p-3">
                        <div className="flex items-center gap-2"><span>🌙</span><span>Dark mode</span></div>
                        <input type="checkbox" defaultChecked={!!getPrefs().dark} onChange={(e)=>{ const p={ ...getPrefs(), dark:e.target.checked }; setPrefs(p); document.body.classList.toggle('theme-dark', p.dark); }}/>
                      </div>
                      <div className="flex items-center justify-between p-3">
                        <div className="flex items-center gap-2"><span>🖼️</span><span>Show background watermark</span></div>
                        <input type="checkbox" defaultChecked={getPrefs().watermark===undefined? true : !!getPrefs().watermark} onChange={(e)=>{ const p={ ...getPrefs(), watermark:e.target.checked }; setPrefs(p); const wm=document.querySelector('.wm'); if(wm) wm.style.display = p.watermark? 'block':'none'; }}/>
                      </div>
                    </div>
                  </div>
                  <div>
                    <div className="text-xs font-semibold text-slate-500 mb-1">Audience and visibility</div>
                    <div className="rounded-xl border border-slate-200">
                      <details>
                        <summary className="cursor-pointer p-3 flex items-center gap-2">👤 Profile details</summary>
                        <div className="px-3 pb-3 space-y-2">
                          <label className="block text-sm">Full name<input value={profile.name||''} onChange={e=>update('name', e.target.value)} className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2"/></label>
                          <label className="block text-sm">Bio<textarea value={profile.bio||''} onChange={e=>update('bio', e.target.value)} className="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" rows="3"/></label>
                          <div className="text-right"><button onClick={()=>{ save(); setShowUserSettings(false); }} className="rounded-lg px-3 py-2 btn-brand text-sm">Save</button></div>
                        </div>
                      </details>
                    </div>
                  </div>
                </div>
                <div className="pt-2 text-right">
                  <button onClick={()=>{ localStorage.removeItem('uniconSessionEmail'); window.location.href='login.html'; }} className="rounded-lg px-3 py-2 text-sm border border-red-200 text-red-700 hover:bg-red-50">Log out</button>
                </div>
              </div>
            </div>
          )}

          {/* Social composer */}
          <div className="rounded-2xl border border-slate-200 bg-white">
            <div className="p-4 flex items-start gap-3">
              {String(profile.avatar||'').startsWith('data:') ? (
                <img src={profile.avatar} className="h-10 w-10 rounded-full object-cover border border-slate-200" alt="avatar"/>
              ) : (
                <div className="h-10 w-10 rounded-full grid place-items-center text-lg bg-slate-100 border border-slate-200" aria-hidden>{(profile.avatar||'👤')}</div>
              )}
              <div className="flex-1">
                <input value={postText} onChange={e=>setPostText(e.target.value)} placeholder="What's on your mind?" className="w-full rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-slate-700"/>
                {postMedia && (<div className="mt-3"><img src={postMedia} alt="preview" className="max-h-56 rounded-lg object-cover"/></div>)}
              </div>
              { (postText.trim() || postMedia) && <button onClick={submitPost} className="ml-2 rounded-full px-4 py-2 btn-brand">Post</button> }
            </div>
            <div className="border-t border-slate-200 px-4 py-3 grid md:grid-cols-3 gap-2 text-sm">
              <button onClick={()=>toast('Live video is coming soon!','info')} className="rounded-lg px-3 py-2 bg-slate-50 hover:bg-slate-100 text-slate-700 text-left">📹 Live video</button>
              <button onClick={()=>mediaRef.current && mediaRef.current.click()} className="rounded-lg px-3 py-2 bg-slate-50 hover:bg-slate-100 text-slate-700 text-left">🖼️ Photo/video</button>
              <button onClick={()=> setPostText(t=> t || '🎉 Life event: ')} className="rounded-lg px-3 py-2 bg-slate-50 hover:bg-slate-100 text-slate-700 text-left">🚩 Life event</button>
              <input ref={mediaRef} type="file" accept="image/*,video/*" className="hidden" onChange={changeMedia} />
            </div>
          </div>

          {/* Your posts */}
          <div className="space-y-3">
            {posts.map(p=> (
              <div key={p.id} className="rounded-xl border border-slate-200 bg-white p-4">
                <div className="flex items-center justify-between text-xs text-slate-500"><span>Your post</span><button onClick={()=>removePost(p.id)} className="hover:underline">Delete</button></div>
                {p.text && <div className="mt-1 text-slate-800">{p.text}</div>}
                {p.media && <div className="mt-2"><img src={p.media} alt="media" className="max-h-72 rounded-lg object-cover"/></div>}
              </div>
            ))}
            {posts.length===0 && <div className="text-sm text-slate-500">No posts yet. Share something above.</div>}
          </div>
        </div>
      );
    }

    function App(){
      const [session, setSession] = useState(localStorage.getItem('uniconSessionEmail'));
      const prefs = getPrefs();
      if (prefs.dark) document.body.classList.add('theme-dark');
      const [tab, setTab] = useState(()=> prefs.tab || 'forYou');
      const [notif, setNotif] = useState(()=>{ try{ return Number(localStorage.getItem('unicon_notif')||'41'); }catch{ return 0; } });
      const [dark, setDark] = useState(!!prefs.dark);
      function toggleTheme(){
        const next = !dark; setDark(next);
        if (next) document.body.classList.add('theme-dark'); else document.body.classList.remove('theme-dark');
        setPrefs({ ...getPrefs(), dark: next });
      }
      React.useEffect(()=>{ try{ localStorage.setItem('unicon_notif', String(notif)); }catch{} }, [notif]);
      const [search, setSearch] = useState('');
      const searchRef = React.useRef(null);
      const scrollPositions = React.useRef({});
      const [cmd, setCmd] = useState(false);
      if (!session) {
        window.location.href = 'login.html';
        return null;
      }
      React.useEffect(()=>{ setPrefs({ ...getPrefs(), tab }); }, [tab]);
      // restore scroll per tab
      React.useEffect(()=>{ const y = scrollPositions.current[tab] || 0; requestAnimationFrame(()=> window.scrollTo(0, y)); }, [tab]);
      React.useEffect(()=>{ const wm = document.querySelector('.wm'); const pref = getPrefs(); const show = (pref.watermark===undefined) ? true : !!pref.watermark; wm.style.display = show ? 'block' : 'none'; }, []);
      React.useEffect(()=>{
        function onKey(e){
          const map = { '1':'forYou','2':'community','3':'marketplace','4':'calendar','5':'profile' };
          if (map[e.key]) { scrollPositions.current[tab] = window.scrollY; setTab(map[e.key]); }
          if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); setCmd(true); }
        }
        window.addEventListener('keydown', onKey);
        return ()=>window.removeEventListener('keydown', onKey);
      }, []);
      return (
        <div className="min-h-screen text-slate-900 relative">
          <div className="wm" style={{ backgroundImage: `url('${(branding && branding.plan==='Premium' && branding.logoData) ? branding.logoData : 'UNICON.png?v=1758434378'}')` }} aria-hidden="true"></div>
          <header className="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
            <div className="max-w-7xl mx-auto px-3 h-16 flex items-center justify-between gap-3">
              <button type="button" onClick={()=>setTab('profile')} title="Open profile" className="flex items-center gap-3 rounded-lg hover:bg-slate-50 px-2 py-1">
                <LogoMark size={48}/>
                <div><h1 className="text-xl font-bold" style={{ background:'linear-gradient(135deg, color-mix(in srgb, var(--brand-color) 80%, white), var(--brand-color))', WebkitBackgroundClip:'text', color:'transparent' }}>UNICON</h1><p className="text-xs text-slate-600">{getBranding()?.name || 'Your School'}</p></div>
              </button>
              <div className="flex-1 max-w-xl">
                <div className="relative">
                  <input ref={searchRef} value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={(e)=>{ if(e.key==='Enter'){ toast('Search coming soon','info'); } }} placeholder="Search (Press ⌘/Ctrl+K)" className="w-full rounded-full border border-slate-200 bg-slate-50 px-4 py-2 pl-9"/>
                  <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"/>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <button className="text-slate-700 hover:text-slate-900" title="Bookmarks" aria-label="Bookmarks"><Bookmark/></button>
                <button onClick={()=>setNotif(0)} className="relative text-slate-700 hover:text-slate-900" title="Notifications" aria-label="Notifications">
                  <Bell/>
                  {notif>0 && (<span className="absolute -top-2 -right-2 inline-flex items-center justify-center text-[10px] font-semibold rounded-full bg-amber-400 text-slate-900 h-5 px-2">{notif}</span>)}
                </button>
                <button onClick={toggleTheme} className="text-slate-700 hover:text-slate-900" title="Toggle theme" aria-label="Toggle theme">{dark?'☀️':'🌙'}</button>
                <button onClick={()=>setTab('moments')} className="text-slate-700 hover:text-slate-900" title="Messages" aria-label="Messages"><MessageSquare/></button>
                <button onClick={()=>setTab('profile')} className="h-9 w-9 rounded-full overflow-hidden border border-slate-200 bg-slate-100">
                  {(()=>{ try{ const p=JSON.parse(localStorage.getItem('uniconProfile')||'null'); if(p && String(p.avatar||'').startsWith('data:')) return <img src={p.avatar} alt="me" className="h-full w-full object-cover"/>; }catch{} return <span className="grid place-items-center h-full w-full">👤</span>; })()}
                </button>
              </div>
            </div>
          </header>
          <main className="max-w-7xl mx-auto px-2 pt-4 pb-16 space-y-4">
            {/* Top tabs removed as requested */}
            <div>
              {/* promo cards show only on Dashboard */}
              {tab==='forYou' && (
                <div className="grid md:grid-cols-2 gap-3 mb-3">
                  <div className="rounded-2xl p-4 border border-slate-200" style={{ background:'color-mix(in srgb, var(--brand-color) 25%, #fff)' }}>
                    <div className="text-xl font-semibold mb-1">Bootcamps & opportunities</div>
                    <p className="text-slate-700">Join campus programs and build portfolio‑ready projects.</p>
                  </div>
                  <div className="rounded-2xl p-4 border border-slate-200 bg-white">
                    <div className="text-xl font-semibold mb-1">Featured event</div>
                    <p className="text-slate-700">Full Stack Developer Bootcamp for beginners.</p>
                  </div>
                </div>
              )}
            {tab==='forYou' && <MotionDiv initial={{opacity:0,y:8}} animate={{opacity:1,y:0}} className="space-y-4 bg-white/80 backdrop-blur rounded-2xl p-3"><h2 className="text-xl font-semibold">Announcements</h2><ForYouFeed/><h3 className="text-lg font-semibold mt-4">Upcoming events</h3><Events/></MotionDiv>}
            {(tab==='community' || tab==='forums') && <MotionDiv initial={{opacity:0,y:8}} animate={{opacity:1,y:0}} className="bg-white/80 backdrop-blur rounded-2xl p-3"><Forums/></MotionDiv>}
            {tab==='marketplace' && <MotionDiv initial={{opacity:0,y:8}} animate={{opacity:1,y:0}} className="space-y-4"><Marketplace/></MotionDiv>}
            {tab==='moments' && <MotionDiv initial={{opacity:0,y:8}} animate={{opacity:1,y:0}} className="space-y-4"><Moments/></MotionDiv>}
            {tab==='calendar' && <MotionDiv initial={{opacity:0,y:8}} animate={{opacity:1,y:0}} className="space-y-4"><CalendarTab/></MotionDiv>}
            {tab==='profile' && <MotionDiv initial={{opacity:0,y:8}} animate={{opacity:1,y:0}} className="space-y-4"><Profile/></MotionDiv>}
            </div>
          </main>
          <BottomNav active={tab} onChange={(k)=>{ scrollPositions.current[tab]=window.scrollY; setTab(k); }}/>
          <Toasts/>
          <ConfirmDialog/>
          <CommandPalette open={cmd} onClose={()=>setCmd(false)} onNavigate={({tab:goTab, space})=>{ setCmd(false); scrollPositions.current[tab]=window.scrollY; setTab(goTab); if(space){ setTimeout(()=>{ try{ location.hash = `#space=${encodeURIComponent(space)}`; }catch{} },0); } }}/>
        </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
