<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNICON – Marketplace</title>
  <link rel="icon" href="../UNICON.png?v=1758434378" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root{ --brand-color:#1D4E89; }
    body{ font-family:Inter, ui-sans-serif, system-ui; background:#fbf7f3; color:#0f172a; }
    .wm{position:fixed;inset:0;pointer-events:none;background-repeat:no-repeat;background-position:center;background-size:min(60vw,680px);opacity:.08;z-index:0}
    .btn-brand{ background:var(--brand-color); color:#fff; }
  </style>
</head>
<body class="antialiased">
  <div class="wm" style="background-image:url('../UNICON.png?v=1758434378')" aria-hidden="true"></div>
  <main class="relative z-10 min-h-screen px-4 py-6">
    <header class="max-w-6xl mx-auto mb-4 flex items-center gap-3 justify-between">
      <div class="hidden md:flex items-center gap-2 flex-1 max-w-xl">
        <div class="relative flex-1">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="globalSearch" type="search" placeholder="Search items…" class="w-full rounded-full border border-slate-200 bg-white px-10 py-2 text-sm" />
        </div>
      </div>
      <div class="relative flex items-center gap-2">
        <button title="Notifications" class="h-9 w-9 grid place-items-center rounded-full border border-slate-200 bg-white">🔔</button>
        <button id="userMenuBtn" title="Account" class="h-9 w-9 rounded-full border border-slate-200 bg-[var(--brand-color)] text-white grid place-items-center">👤</button>
        <div id="userMenu" class="hidden absolute right-0 top-12 w-60 rounded-2xl border border-slate-200 bg-white shadow-xl p-2">
          <a id="menuProfile" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50 text-[var(--brand-color)]" href="javascript:void(0)">👤 Profile</a>
          <a id="menuSettings" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50" href="javascript:void(0)">⚙️ Settings</a>
          <a id="menuHome" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50" href="javascript:void(0)">🏠 My Home</a>
          <a id="menuHelp" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50" href="javascript:void(0)">❓ Help Center ↗</a>
          <div class="my-2 border-t"></div>
          <a id="menuLogout" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50 text-rose-600" href="javascript:void(0)">Log Out</a>
        </div>
      </div>
    </header>
    <section class="max-w-6xl mx-auto">
      <div id="root"><div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">Loading…</div></div>
    </section>
  </main>

  <nav class="fixed bottom-3 left-1/2 -translate-x-1/2 z-40">
    <ul class="flex gap-1 bg-white/90 backdrop-blur border border-slate-200 rounded-2xl p-1 shadow-xl">
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="for-you.html">For you</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="community.html">Community</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="messages.html">Messages</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm btn-brand" href="marketplace.html">Marketplace</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="calendar.html">Calendar</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="profile.html">Profile</a></li>
    </ul>
</nav>
<script type="text/babel" data-presets="env,react">
  const { useState } = React;
  function getBranding(){ try { return JSON.parse(localStorage.getItem('uniconBrand')||'null'); }catch{ return null; } }
  function applyBranding(b){ const root = document.body; if (b?.color){ root.style.setProperty('--brand-color', b.color);} }
  const branding = getBranding(); applyBranding(branding);
  (function(){
    const menuBtn = document.getElementById('userMenuBtn');
    const menu = document.getElementById('userMenu');
    if(menuBtn && menu){ menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('hidden'); }); document.addEventListener('click', ()=> menu.classList.add('hidden')); }
    function nav(id, href){ const el=document.getElementById(id); if(!el) return; el.addEventListener('click', ()=>{ if(id==='menuLogout'){ try{ localStorage.removeItem('uniconSessionEmail'); }catch{} } location.href = href; }); }
    nav('menuProfile','profile.html'); nav('menuSettings','settings.html'); nav('menuHome','for-you.html'); const help=document.getElementById('menuHelp'); if(help) help.addEventListener('click', ()=> window.open('https://example.com/help','_blank'));
    const input = document.getElementById('globalSearch'); if(input){ const saved=localStorage.getItem('unicon_global_search')||''; if(saved) input.value=saved; input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ localStorage.setItem('unicon_global_search', input.value); try{ window.dispatchEvent(new CustomEvent('unicon_search',{ detail: input.value })); }catch{} } }); }
  })();
  async function compressImage(dataUrl, max=1600){
    try{
      const img = new Image(); img.src = dataUrl; await new Promise(r=>{ img.onload=r; img.onerror=r; });
      const w = img.width, h = img.height; const scale = Math.min(1, max/Math.max(w,h));
      if(scale>=1) return dataUrl;
      const canvas = document.createElement('canvas'); canvas.width = Math.round(w*scale); canvas.height = Math.round(h*scale);
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }catch{ return dataUrl; }
  }

  function Marketplace(){
    const defaults = [
      { id:'1', title:'USP Hoodie', price:45, verified:true, category:'Apparel', condition:'New', seller:'USP Store', contact:'store@usp.edu', desc:'Official campus hoodie. Sizes S-XL.', images:[], sold:false },
      { id:'2', title:'Calculus Textbook', price:35, verified:false, category:'Textbooks', condition:'Used - Good', seller:'Alex', contact:'alex@example.com', desc:'Stewart Calculus 8th Edition.', images:[], sold:false },
    ];
    const sessionEmail = localStorage.getItem('uniconSessionEmail') || '';
    let profName = 'You';
    try { const p = JSON.parse(localStorage.getItem('uniconProfile')||'null'); if(p?.name) profName = p.name; } catch {}
    const [items, setItems] = useState(()=>{ 
      try{ 
        const raw = JSON.parse(localStorage.getItem('unicon_market')||'null') || defaults; 
        return raw.map(i=> i.images? i : { ...i, images: i.img? [i.img] : [] });
      }catch{ return defaults; } 
    });
    React.useEffect(()=>{ try{ localStorage.setItem('unicon_market', JSON.stringify(items)); }catch{} }, [items]);
    const f0 = (()=>{ try{ return JSON.parse(localStorage.getItem('unicon_market_filters')||'null')||{}; }catch{ return {}; } })();
    const [query, setQuery] = useState(f0.query||'');
    const [cat, setCat] = useState(f0.cat||'All');
    const [cond, setCond] = useState(f0.cond||'All');
    const [minP, setMinP] = useState(f0.minP||'');
    const [maxP, setMaxP] = useState(f0.maxP||'');
    const [onlyV, setOnlyV] = useState(!!f0.onlyV);
    const [sortBy, setSortBy] = useState(f0.sortBy||'Newest');
    const [onlySaved, setOnlySaved] = useState(!!f0.onlySaved);
    const [onlyMine, setOnlyMine] = useState(!!f0.onlyMine);
    const [visible, setVisible] = useState(12);
    const [wish, setWish] = useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_market_wish')||'null')||{}; }catch{ return {}; } });
    React.useEffect(()=>{ try{ localStorage.setItem('unicon_market_wish', JSON.stringify(wish)); }catch{} }, [wish]);
    React.useEffect(()=>{ function on(e){ setQuery(e.detail||''); } window.addEventListener('unicon_search', on); return ()=>window.removeEventListener('unicon_search', on); }, []);
    const [view, setView] = useState(null);

    const categories = ['All','Textbooks','Study Materials','Calculators','Lab Equipment','Apparel','Electronics','Furniture','Dorm Essentials','Tickets','Rideshare','Tutoring','Other'];
    const conditions = ['All','New','Like New','Used - Good','Used - Fair'];
    const locations = ['Any','Main Library','Student Center','Cafeteria','Gym Lobby','Dorm A Lobby','Admin Building','North Gate','South Gate'];
    const payments = ['Cash','Bank Transfer','Campus Card'];
    const fmt = (n)=> new Intl.NumberFormat(undefined,{ style:'currency', currency:'USD', maximumFractionDigits:0 }).format(Number(n||0));
    const contactHref = (c)=> String(c||'').includes('@')? `mailto:${c}` : `tel:${c}`;

    const [form, setForm] = useState({ title:'', price:'', category:'Textbooks', condition:'Used - Good', seller:profName, contact:sessionEmail, desc:'', images:[], location:'Main Library', payment:'Cash', meta:{} });
    const imgRef = React.useRef(null);
    async function onImg(e){ const files = Array.from(e.target.files||[]).slice(0,4); if(files.length===0) return; const readers = files.map(f=> new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); })); const imgs = await Promise.all(readers); const compressed = await Promise.all(imgs.map(src=> compressImage(src, 1600))); setForm(f=> ({...f, images: [...(f.images||[]), ...compressed].slice(0,4)})); }
    function add(){ if(!form.title.trim()) return; const id=String(Date.now()); const verifiedAuto = /@[^\s]+\.edu$/.test(String(form.contact||'')); const postedAt=Date.now(); setItems([{ id, ...form, price:Number(form.price)||0, verified: verifiedAuto, sold:false, postedAt }, ...items]); setForm({ title:'', price:'', category:'Textbooks', condition:'Used - Good', seller:profName, contact:sessionEmail, desc:'', images:[], location:'Main Library', payment:'Cash', meta:{} }); if(imgRef.current) imgRef.current.value=''; }

    function filtered(){
      let list = items.filter(it=> (cat==='All'||it.category===cat) && (cond==='All'||it.condition===cond) && (!query || it.title.toLowerCase().includes(query.toLowerCase())) && (!onlyV || it.verified) && (!onlySaved || wish[it.id]) && (!onlyMine || (it.contact===sessionEmail || it.seller===profName)) );
      if(minP) list = list.filter(i=> Number(i.price)>=Number(minP));
      if(maxP) list = list.filter(i=> Number(i.price)<=Number(maxP));
      if(sortBy==='Low to high') list.sort((a,b)=> Number(a.price)-Number(b.price));
      else if(sortBy==='High to low') list.sort((a,b)=> Number(b.price)-Number(a.price));
      else list.sort((a,b)=> (b.postedAt||0)-(a.postedAt||0));
      return list.slice(0, visible);
    }
    function toggleWish(id){ setWish(w=> ({...w, [id]: !w[id] })); }
    function markSold(id){ setItems(arr=> arr.map(it=> it.id===id? {...it, sold:true } : it)); }
    function remove(id){ setItems(arr=> arr.filter(i=> i.id!==id)); }

    return (
      <div className="space-y-4">
        <div className="bg-white rounded-xl border border-slate-200 p-4">
          <div className="grid md:grid-cols-[1fr_1fr_1fr_1fr] gap-2">
            <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search listings" className="rounded-lg border border-slate-300 px-3 py-2"/>
            <select value={cat} onChange={e=>setCat(e.target.value)} className="rounded-lg border border-slate-300 px-3 py-2"><option>All</option>{categories.slice(1).map(c=> <option key={c}>{c}</option>)}</select>
            <select value={cond} onChange={e=>setCond(e.target.value)} className="rounded-lg border border-slate-300 px-3 py-2"><option>All</option>{conditions.slice(1).map(c=> <option key={c}>{c}</option>)}</select>
            <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="rounded-lg border border-slate-300 px-3 py-2"><option>Newest</option><option>Low to high</option><option>High to low</option></select>
            <div className="md:col-span-4 grid md:grid-cols-5 gap-2">
              <input value={minP} onChange={e=>setMinP(e.target.value)} placeholder="Min price" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <input value={maxP} onChange={e=>setMaxP(e.target.value)} placeholder="Max price" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={onlyV} onChange={e=>setOnlyV(e.target.checked)}/> Verified</label>
              <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={onlySaved} onChange={e=>setOnlySaved(e.target.checked)}/> Saved</label>
              <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={onlyMine} onChange={e=>setOnlyMine(e.target.checked)}/> Mine</label>
            </div>
          </div>
        </div>

        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {filtered().map(it=> (
            <div key={it.id} className="rounded-2xl border border-slate-200 bg-white p-3">
              <div className="flex items-start justify-between">
                <div className="font-medium">{it.title}</div>
                <button onClick={()=>toggleWish(it.id)} className={`text-sm ${wish[it.id]? 'text-rose-600':'text-slate-600'}`}>♥</button>
              </div>
              <div className="text-sm text-slate-600">{it.category} • {it.condition}</div>
              <div className="mt-2 text-xl font-semibold">{fmt(it.price)}</div>
              {it.images?.[0] && <img src={it.images[0]} alt="" className="mt-2 h-32 w-full object-cover rounded-lg"/>}
              <div className="mt-3 flex items-center justify-between text-sm">
                <a href={contactHref(it.contact)} className="btn-brand rounded-md px-3 py-1">Contact</a>
                {it.verified && <span className="text-xs text-green-700">Verified</span>}
              </div>
              <div className="mt-2 text-xs text-slate-500">Seller: {it.seller}</div>
              {!it.sold? (
                <div className="mt-2 flex items-center gap-2">
                  <button onClick={()=>setView(it)} className="rounded-md px-2 py-1 border">View</button>
                  { (it.contact===sessionEmail || it.seller===profName) && (
                    <>
                      <button onClick={()=>markSold(it.id)} className="rounded-md px-2 py-1 border">Mark sold</button>
                      <button onClick={()=>remove(it.id)} className="rounded-md px-2 py-1 border">Remove</button>
                    </>
                  )}
                </div>
              ) : (<div className="mt-2 text-xs text-amber-700">Sold</div>)}
            </div>
          ))}
        </div>

        <div className="bg-white rounded-xl border border-slate-200 p-4">
          <div className="font-medium mb-2">Create listing</div>
          <div className="grid md:grid-cols-2 gap-2">
            <input value={form.title} onChange={e=>setForm(f=>({...f,title:e.target.value}))} placeholder="Title" className="rounded-lg border border-slate-300 px-3 py-2"/>
            <input value={form.price} onChange={e=>setForm(f=>({...f,price:e.target.value}))} placeholder="Price" className="rounded-lg border border-slate-300 px-3 py-2"/>
            <select value={form.category} onChange={e=>setForm(f=>({...f,category:e.target.value}))} className="rounded-lg border border-slate-300 px-3 py-2">
              {categories.map(c=> <option key={c}>{c}</option>)}
            </select>
            <select value={form.condition} onChange={e=>setForm(f=>({...f,condition:e.target.value}))} className="rounded-lg border border-slate-300 px-3 py-2">
              {conditions.map(c=> <option key={c}>{c}</option>)}
            </select>
            <input value={form.seller} onChange={e=>setForm(f=>({...f,seller:e.target.value}))} placeholder="Seller name" className="rounded-lg border border-slate-300 px-3 py-2"/>
            <input value={form.contact} onChange={e=>setForm(f=>({...f,contact:e.target.value}))} placeholder="Contact (email/phone)" className="rounded-lg border border-slate-300 px-3 py-2"/>
            <input value={form.location} onChange={e=>setForm(f=>({...f,location:e.target.value}))} placeholder="Meet-up location" className="rounded-lg border border-slate-300 px-3 py-2"/>
            <select value={form.payment} onChange={e=>setForm(f=>({...f,payment:e.target.value}))} className="rounded-lg border border-slate-300 px-3 py-2">
              {payments.map(p=> <option key={p}>{p}</option>)}
            </select>
            <textarea value={form.desc} onChange={e=>setForm(f=>({...f,desc:e.target.value}))} rows="3" placeholder="Description" className="md:col-span-2 rounded-lg border border-slate-300 px-3 py-2"></textarea>
            <div className="md:col-span-2">
              <input ref={imgRef} type="file" accept="image/*" multiple onChange={onImg}/>
              <div className="mt-2 flex gap-2 flex-wrap">
                {form.images.map((src,i)=> (<img key={i} src={src} className="h-16 w-16 rounded object-cover border"/>))}
              </div>
            </div>
            <div className="md:col-span-2"><button onClick={add} className="rounded-md px-4 py-2 btn-brand">Add listing</button></div>
          </div>
        </div>
        {view && (
          <div className="fixed inset-0 z-50 bg-black/40 grid place-items-center p-3" onClick={()=>setView(null)}>
            <div className="bg-white rounded-2xl border border-slate-200 max-w-2xl w-full p-4" onClick={(e)=>e.stopPropagation()}>
              <div className="flex items-start justify-between">
                <div>
                  <div className="text-xl font-semibold">{view.title}</div>
                  <div className="text-sm text-slate-600">{view.category} • {view.condition}</div>
                </div>
                <button onClick={()=>setView(null)} className="rounded-md border px-2 py-1">Close</button>
              </div>
              {view.images?.length>0 && (
                <div className="mt-3 grid grid-cols-3 gap-2">
                  {view.images.map((src,i)=> (<img key={i} src={src} className="h-28 w-full object-cover rounded-lg border"/>))}
                </div>
              )}
              <div className="mt-3">
                <div className="text-lg font-semibold">{fmt(view.price)}</div>
                <p className="mt-1 text-slate-700 whitespace-pre-wrap">{view.desc}</p>
                <div className="mt-2 text-sm text-slate-600">Meet-up: {view.location} • Payment: {view.payment}</div>
              </div>
              <div className="mt-4 flex items-center gap-2">
                <a href={contactHref(view.contact)} className="btn-brand rounded-md px-4 py-2">Contact seller</a>
                {view.verified && <span className="text-xs text-green-700">Verified</span>}
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }
  function MarketplacePage(){ return (<div className="space-y-4"><Marketplace/></div>); }
  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<MarketplacePage/>);
</script>
</body>
</html>
