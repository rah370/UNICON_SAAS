<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNICON ‚Äì Community</title>
  <link rel="icon" href="../UNICON.png?v=1758434378" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root{ --brand-color:#1D4E89; }
    body{ font-family:Inter, ui-sans-serif, system-ui; background:#fbf7f3; color:#0f172a; }
    .wm{position:fixed;inset:0;pointer-events:none;background-repeat:no-repeat;background-position:center;background-size:min(60vw,680px);opacity:.08;z-index:0}
    .btn-brand{ background:var(--brand-color); color:#fff; }
  </style>
</head>
<body class="antialiased">
  <div class="wm" style="background-image:url('../UNICON.png?v=1758434378')" aria-hidden="true"></div>
  <main class="relative z-10 min-h-screen px-4 py-6">
    <header class="max-w-6xl mx-auto mb-4 flex items-center justify-between">
      <a href="index.html" class="text-sm text-slate-600 hover:underline">‚Üê Back to landing</a>
      <div class="text-sm text-slate-600">Community</div>
    </header>
    <section class="max-w-6xl mx-auto">
      <div id="root"><div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">Loading‚Ä¶</div></div>
    </section>
  </main>

  <nav class="fixed bottom-3 left-1/2 -translate-x-1/2 z-40">
    <ul class="flex gap-1 bg-white/90 backdrop-blur border border-slate-200 rounded-2xl p-1 shadow-xl">
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="for-you.html">For you</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm btn-brand" href="community.html">Community</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="messages.html">Messages</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="marketplace.html">Marketplace</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="calendar.html">Calendar</a></li>
      <li><a class="flex items-center gap-2 rounded-[1rem] px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" href="profile.html">Profile</a></li>
    </ul>
</nav>
<script type="text/babel" data-presets="env,react">
  const { useState } = React;
  function getBranding(){ try { return JSON.parse(localStorage.getItem('uniconBrand')||'null'); }catch{ return null; } }
  function applyBranding(b){ const root = document.body; if (b?.color){ root.style.setProperty('--brand-color', b.color);} }
  const branding = getBranding(); applyBranding(branding);
  function toast(message, type='info'){ try{ window.dispatchEvent(new CustomEvent('unicon_toast', { detail:{ message, type, id:String(Date.now()) } })); }catch{} }

  // Minimal helpers reused by Forums page
  async function compressImage(dataUrl, max=1600){
    try{
      const img = new Image(); img.src = dataUrl; await new Promise(r=>{ img.onload=r; img.onerror=r; });
      const w = img.width, h = img.height; const scale = Math.min(1, max/Math.max(w,h));
      if(scale>=1) return dataUrl;
      const canvas = document.createElement('canvas'); canvas.width = Math.round(w*scale); canvas.height = Math.round(h*scale);
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }catch{ return dataUrl; }
  }
  const store = { get(k,f){ try{ const v=JSON.parse(localStorage.getItem(k)||'null'); return v==null? f : v; }catch{ return f; } }, set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} } };

  function SpaceComposer({ onPost }){
    const [text, setText] = useState('');
    const [media, setMedia] = useState('');
    const ref = React.useRef(null);
    async function changeMedia(e){ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); const data = await new Promise(res=>{ r.onload=()=>res(r.result); r.readAsDataURL(f); }); const small = await compressImage(data, 1600); setMedia(small); }
    function submit(){ if(!text.trim() && !media) return; onPost({ id:String(Date.now()), text, media, created:new Date().toISOString() }); setText(''); setMedia(''); try{ ref.current.value=''; }catch{} }
    return (
      <div className="rounded-2xl border border-slate-200 bg-white p-4">
        <div className="flex items-start gap-2">
          <div className="h-10 w-10 rounded-full grid place-items-center text-lg bg-slate-100 border border-slate-200" aria-hidden>üë§</div>
          <div className="flex-1">
            <textarea value={text} onChange={e=>setText(e.target.value)} rows="3" placeholder="Start a discussion" className="w-full rounded-lg border border-slate-300 px-3 py-2"/>
            <div className="mt-2 flex items-center gap-2">
              <input ref={ref} type="file" accept="image/*" className="text-xs" onChange={changeMedia}/>
              <button onClick={submit} className="rounded-full px-4 py-2 text-sm btn-brand">Post</button>
            </div>
            {media && <div className="mt-3"><img src={media} className="max-h-56 rounded-lg object-cover" alt="preview"/></div>}
          </div>
        </div>
      </div>
    );
  }

  function Forums(){
    const [space, setSpace] = useState(()=> location.hash.startsWith('#space=')? decodeURIComponent(location.hash.slice(7)) : 'start');
    const [history, setHistory] = useState([]);
    const [posts, setPosts] = useState(()=>{ try{ return JSON.parse(localStorage.getItem('unicon_forum_posts')||'null')||[]; }catch{ return []; } });
    React.useEffect(()=>{ try{ localStorage.setItem('unicon_forum_posts', JSON.stringify(posts)); }catch{} }, [posts]);
    function addPost(p){ setPosts(a=> [p,...a]); }
    function removePost(id){ setPosts(a=> a.filter(x=> x.id!==id)); }
    function goTo(s){ setHistory(h=> [...h, space]); setSpace(s); try{ location.hash = `#space=${encodeURIComponent(s)}`; }catch{} }
    function goBack(){ setHistory(h=>{ const x=[...h]; const prev=x.pop(); if(prev) setSpace(prev); return x; }); }

    const [departments, setDepartments] = useState(()=> store.get('unicon_departments',[ 'Announcements','Events','Projects','Challenges']));
    const [newDep, setNewDep] = useState('');
    const [clubs, setClubs] = useState(()=> store.get('unicon_clubs',[ 'General Club','Tech Club','Photography Club','Business Club','Art Club','Robotics Club','Music Club' ]));
    React.useEffect(()=>{ store.set('unicon_departments', departments); }, [departments]);
    React.useEffect(()=>{ store.set('unicon_clubs', clubs); }, [clubs]);
    const [members, setMembers] = useState(()=> store.get('unicon_memberships',{}));
    React.useEffect(()=>{ store.set('unicon_memberships', members); }, [members]);
    function spaceTitle(s){ if(s.startsWith('dep:')) return `${s.slice(4)} Department`; if(s.startsWith('club:')) return `${s.slice(5)} Club`; return s==='start'? 'Start here' : s==='events'? 'Events' : s==='announcements'? 'Announcements' : s==='study'? 'Live Study' : 'Community'; }
    function listClubs(dep){ return clubs.filter(c=> c.toLowerCase().includes(dep.toLowerCase().slice(0,2))); }
    function countPostsFor(name){ try{ const k=`unicon_dep_posts:${name}`; const arr=JSON.parse(localStorage.getItem(k)||'null')||[]; return arr.length; }catch{ return 0; } }
    function countPostsForClub(name){ try{ const k=`unicon_club:${name}`; const arr=JSON.parse(localStorage.getItem(k)||'null')||[]; return arr.length; }catch{ return 0; } }
    function JoinSpaceButton({ space }){
      const [joined, setJoined] = React.useState(()=>{ try{ const m=JSON.parse(localStorage.getItem('unicon_memberships')||'{}'); return !!m[space]; }catch{ return false; } });
      function toggle(){ setJoined(j=>{ const next=!j; try{ const m=JSON.parse(localStorage.getItem('unicon_memberships')||'{}'); m[space]=next; localStorage.setItem('unicon_memberships', JSON.stringify(m)); }catch{} return next; }); }
      return (<button onClick={toggle} className={`rounded-full px-3 py-1 text-sm ${joined? 'text-green-700 bg-green-50 border border-green-200':'btn-brand'}`}>{joined? 'Joined' : 'Join space'}</button>);
    }

    function ClubView({ name }){
      const storageKey = `unicon_club:${name}`;
      const [posts, setPosts] = React.useState(()=>{ try{ return JSON.parse(localStorage.getItem(storageKey)||'null') || []; }catch{ return []; } });
      React.useEffect(()=>{ try{ localStorage.setItem(storageKey, JSON.stringify(posts)); }catch{} }, [posts, storageKey]);
      const [text, setText] = React.useState('');
      const [tag, setTag] = React.useState('All');
      const [link, setLink] = React.useState('');
      function add(){ if(!text.trim() && !link.trim()) return; setPosts(a=> [{ id:String(Date.now()), text, link, tag, t:Date.now() }, ...a]); setText(''); setLink(''); }
      function remove(id){ setPosts(a=> a.filter(p=> p.id!==id)); }
      const tags=['All','Question','Resource','Poll','Event'];
      return (
        <div className="space-y-3">
          <div className="rounded-xl border border-slate-200 bg-white p-3">
            <div className="font-medium mb-2">{name}</div>
            <div className="grid md:grid-cols-[1fr_120px] gap-2">
              <input value={text} onChange={e=>setText(e.target.value)} placeholder="Share something with the club" className="rounded-lg border border-slate-300 px-3 py-2"/>
              <button onClick={add} className="rounded-lg px-3 py-2 btn-brand">Post</button>
              <input value={link} onChange={e=>setLink(e.target.value)} placeholder="Optional link" className="rounded-lg border border-slate-300 px-3 py-2 md:col-span-2"/>
              <select value={tag} onChange={e=>setTag(e.target.value)} className="rounded-lg border border-slate-300 px-3 py-2 md:col-span-2">
                {tags.map(t=> <option key={t}>{t}</option>)}
              </select>
            </div>
          </div>
          <div className="space-y-2">
            {posts.map(p=> (
              <div key={p.id} className="rounded-xl border border-slate-200 bg-white p-3">
                <div className="text-sm text-slate-700 whitespace-pre-wrap">{p.text}</div>
                {p.link && <a href={p.link} className="text-sm text-[var(--brand-color)] underline" target="_blank" rel="noreferrer">{p.link}</a>}
                <div className="mt-2 text-xs text-slate-500 flex items-center justify-between"><span>{new Date(p.t).toLocaleString()}</span><button onClick={()=>remove(p.id)} className="hover:underline">Delete</button></div>
              </div>
            ))}
            {posts.length===0 && <div className="text-sm text-slate-500">No posts yet in this club.</div>}
          </div>
        </div>
      );
    }

    return (
      <div className="grid lg:grid-cols-[260px_1fr] gap-3">
        <aside className="space-y-4">
          <div className="rounded-2xl border border-slate-200 bg-white p-3">
            <div className="text-xs font-semibold text-slate-500 px-1 mb-1">Community</div>
            <nav className="space-y-1" role="navigation" aria-label="Community">
              <button onClick={()=>setSpace('start')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='start'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>‚ú® Start Here</button>
              <button onClick={()=>setSpace('announcements')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='announcements'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>üì£ Announcements</button>
              <button onClick={()=>setSpace('events')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='events'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>üìÖ Events</button>
              <button onClick={()=>setSpace('study')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='study'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>üìö Live Study</button>
              <button onClick={()=>setSpace('club:General Club')} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${space==='club:General Club'?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>üåê General Club</button>
            </nav>
          </div>
          <div className="rounded-2xl border border-slate-200 bg-white p-3">
            <div className="text-xs font-semibold text-slate-500 px-1 mb-2">Departments</div>
            <div className="space-y-1" role="navigation" aria-label="Departments">
              {departments.map(dep=> (
                <button aria-current={space===`dep:${dep}`? 'page' : undefined} key={dep} onClick={()=>setSpace(`dep:${dep}`)} className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm ${space===`dep:${dep}`?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>
                  <span>üè∑Ô∏è {dep}</span>
                  <span className="text-[10px] text-slate-500">{countPostsFor(dep)}</span>
                </button>
              ))}
            </div>
            <div className="mt-2 flex gap-2">
              <input value={newDep} onChange={e=>setNewDep(e.target.value)} placeholder="Add department" className="flex-1 rounded-lg border border-slate-300 px-2 py-1 text-sm"/>
              <button onClick={()=>{ if(!newDep.trim()) return; if(departments.includes(newDep.trim())) return; setDepartments([...departments, newDep.trim()]); setNewDep(''); }} className="rounded-lg px-2 py-1 text-xs btn-brand">Add</button>
            </div>
          </div>

          <div className="rounded-2xl border border-slate-200 bg-white p-3">
            <div className="text-xs font-semibold text-slate-500 px-1 mb-2">Career Clubs</div>
            <div className="space-y-1 max-h-[320px] overflow-auto pr-1" role="navigation" aria-label="Career Clubs">
              {clubs.map(name=> (
                <button aria-current={space===`club:${name}`? 'page' : undefined} key={name} onClick={()=>setSpace(`club:${name}`)} className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm ${space===`club:${name}`?'chip-brand':'hover:bg-slate-50 border border-transparent text-slate-700'}`}>
                  <span>üß© {name}</span>
                  <span className="text-[10px] text-slate-500">{countPostsForClub(name)}</span>
                </button>
              ))}
            </div>
          </div>
        </aside>

        <section>
          <div className="rounded-2xl border border-slate-200 bg-white p-4 mb-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <button onClick={goBack} disabled={history.length===0} className={`h-8 w-8 grid place-items-center rounded-md border ${history.length===0? 'opacity-40 cursor-not-allowed' : 'hover:bg-slate-50'}`}>‚Üê</button>
              <div className="text-lg font-semibold">{spaceTitle(space)}</div>
            </div>
            <JoinSpaceButton key={space} space={space} />
          </div>

          {String(space).startsWith('club:') ? (
            <ClubView name={space.slice(5)} />
          ) : space==='start' ? (
            <div className="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
              {[{key:'wins',title:'Post Your Weekly Wins',dest:'announcements',emoji:'üèÜ'},{key:'event',title:'Attend an Event',dest:'events',emoji:'üìÖ'},{key:'club',title:'Visit General Club',dest:'club:General Club',emoji:'üë•'}].map(c=> (
                <button key={c.key} onClick={()=>setSpace(c.dest)} className="text-left rounded-2xl overflow-hidden border border-slate-200 bg-white shadow-sm hover:shadow-md transition-shadow">
                  <div className="relative h-28" style={{ background:'var(--brand-color)' }}>
                    <div aria-hidden className="absolute inset-0 opacity-20" style={{ backgroundImage:'radial-gradient(#fff 1px, transparent 1px)', backgroundSize:'10px 10px' }}></div>
                    <div className="absolute right-3 bottom-3 text-4xl select-none" aria-hidden>{c.emoji}</div>
                  </div>
                  <div className="px-3 py-3">
                    <div className="font-medium text-slate-900">{c.title}</div>
                  </div>
                </button>
              ))}
            </div>
          ) : (
            <>
              <SpaceComposer onPost={addPost} />
              <div className="mt-3 space-y-3">
                {posts.map(p=> (
                  <div key={p.id} className="rounded-xl border border-slate-200 bg-white p-4">
                    {p.text && <div className="text-slate-800">{p.text}</div>}
                    {p.media && <div className="mt-2"><img src={p.media} alt="media" className="max-h-72 rounded-lg object-cover"/></div>}
                    <div className="mt-2 text-xs text-slate-500 flex items-center justify-between"><span>{new Date(p.created||Date.now()).toLocaleString()}</span><button onClick={()=>removePost(p.id)} className="hover:underline">Delete</button></div>
                  </div>
                ))}
                {posts.length===0 && <div className="text-sm text-slate-500">No posts yet in this space.</div>}
              </div>
            </>
          )}
        </section>
      </div>
    );
  }

  function CommunityPage(){ return (<div className="bg-white/80 backdrop-blur rounded-2xl p-3"><Forums/></div>); }
  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<CommunityPage/>);
</script>
</body>
</html>
